<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Analisis Saham</title>
    
    <!-- Web App Manifest & Icons for Homescreen -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon" href="https://https://res.cloudinary.com/dxeram9ta/image/upload/v1755321174/Analisahamku_rerpxe.svg/180x180/4F46E5/FFFFFF?text=Logo">
    <link rel="icon" type="image/png" sizes="32x32" href="https://res.cloudinary.com/dxeram9ta/image/upload/v1755321174/Analisahamku_rerpxe.svg/32x32/4F46E5/FFFFFF?text=L">
    <link rel="icon" type="image/png" sizes="16x16" href="https://res.cloudinary.com/dxeram9ta/image/upload/v1755321174/Analisahamku_rerpxe.svg/16x16/4F46E5/FFFFFF?text=L">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            color: #111827;
        }
        .dark body {
            background-color: #111827;
            color: #d1d5db;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader { border: 4px solid #d1d5db; border-left-color: #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .dark .loader { border-color: #4b5563; border-left-color: #3b82f6; }
        .mini-loader { border: 2px solid #d1d5db; border-left-color: #3b82f6; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        
        .card { 
            background-color: white; 
            color: #111827;
            border-radius: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05); 
        }
        .dark .card { 
            background-color: #1f2937;
            color: #d1d5db;
        }
        
        .bottom-nav-btn { color: #9ca3af; }
        .bottom-nav-btn.active { color: #3b82f6; font-weight: 600; }
        .dark .bottom-nav-btn { color: #6b7280; }
        .dark .bottom-nav-btn.active { color: #60a5fa; }
        
        .toggle-switch {
            width: 3rem; /* w-12 */
            height: 1.5rem; /* h-6 */
            background-color: #e5e7eb; /* bg-gray-200 */
            border-radius: 9999px; /* rounded-full */
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .dark .toggle-switch {
            background-color: #4b5563; /* dark:bg-gray-600 */
        }
        .toggle-switch-thumb {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            background-color: white;
            border-radius: 9999px; /* rounded-full */
            position: absolute;
            top: 0.125rem; /* top-0.5 */
            left: 0.125rem; /* left-0.5 */
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .toggle-checkbox:checked + .toggle-switch .toggle-switch-thumb {
            transform: translateX(1.5rem); /* translateX(6) */
            background-color: #3b82f6; /* bg-blue-600 */
        }
        .toggle-checkbox {
            display: none;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        
        .dark .custom-select, .dark .price-input, .dark .investor-search-input, .dark #ai-prompt-input, .dark .strategy-input, .dark #direct-analysis-input, .dark .compare-input, .dark #email, .dark #password, .dark #reg-name, .dark #reg-email, .dark #reg-password, .dark #reg-password-confirm, .dark .auth-input {
            color: #111827;
            background-color: #ffffff;
        }

        .sub-tab-btn {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .sub-tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        .dark .sub-tab-btn {
            color: #9ca3af;
        }
        .dark .sub-tab-btn.active {
            border-bottom-color: #60a5fa;
            color: #60a5fa;
        }
        
        /* Styles for Education Module */
        .lesson-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .lesson-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .glossary-btn.active { background-color: #3b82f6; color: white; transform: scale(1.1); }
        .candlestick-part:hover { cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .svg-chart-text { font-size: 10px; fill: currentColor; }
        .svg-chart-grid { stroke: #e5e7eb; }
        .dark .svg-chart-grid { stroke: #374151; }

    </style>
</head>
<body class="transition-colors duration-300">
    
<div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-indigo-700">
    <div class="w-full max-w-sm">
        <div class="bg-white/20 backdrop-blur-lg border border-white/30 rounded-3xl shadow-2xl p-8">
            <img src="https://res.cloudinary.com/dxeram9ta/image/upload/v1755321174/Analisahamku_rerpxe.svg" alt="Logo Analisahamku" class="mx-auto h-20 w-auto mb-6">
            <h1 id="auth-title" class="text-3xl font-bold text-center text-white mb-2">Selamat Datang</h1>
            <p id="auth-subtitle" class="text-center text-blue-200 mb-8">Masuk ke Akun Anda</p>
            
            <div id="login-form">
                <form id="login-form-content" class="space-y-6">
                    <div>
                        <label for="email" class="block text-blue-100 text-sm font-bold mb-2">Email</label>
                        <input id="email" type="email" placeholder="Masukkan email Anda" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="password" class="block text-blue-100 text-sm font-bold mb-2">Password</label>
                        <input id="password" type="password" placeholder="Masukkan password Anda" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <div class="flex items-center justify-end">
                        <button type="button" id="forgot-password-button" class="text-sm text-blue-200 hover:text-white transition-colors duration-200">Lupa Password?</button>
                    </div>
                    <button type="submit" id="login-button" class="w-full bg-white hover:bg-gray-200 text-blue-600 font-bold py-3 px-4 rounded-full transition-colors duration-300 text-lg">Masuk</button>
                    <p id="auth-error" class="text-yellow-300 text-center text-sm mt-4 hidden"></p>
                </form>
            </div>
            
            <div id="register-form" class="hidden">
                 <form id="register-form-content" class="space-y-6">
                    <div>
                        <label for="reg-name" class="block text-blue-100 text-sm font-bold mb-2">Nama Pengguna</label>
                        <input id="reg-name" type="text" placeholder="Masukkan nama Anda" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="reg-email" class="block text-blue-100 text-sm font-bold mb-2">Email</label>
                        <input id="reg-email" type="email" placeholder="Masukkan email Anda" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="reg-password" class="block text-blue-100 text-sm font-bold mb-2">Password</label>
                        <input id="reg-password" type="password" placeholder="Buat password" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <div>
                        <label for="reg-password-confirm" class="block text-blue-100 text-sm font-bold mb-2">Konfirmasi Password</label>
                        <input id="reg-password-confirm" type="password" placeholder="Ulangi password" class="w-full bg-white/20 border border-white/30 rounded-full py-3 px-5 text-white placeholder-blue-200 focus:outline-none focus:ring-2 focus:ring-white">
                    </div>
                    <button type="submit" id="register-button" class="w-full bg-white hover:bg-gray-200 text-blue-600 font-bold py-3 px-4 rounded-full transition-colors duration-300 text-lg">Daftar</button>
                </form>
            </div>

            <!-- BARU: TAMPILAN STATUS PENDING -->
            <div id="pending-form" class="hidden text-center text-white">
                <h1 class="text-3xl font-bold mb-4">Pendaftaran Berhasil</h1>
                <p class="text-blue-200 mb-6">Akun Anda (<span id="pending-email" class="font-bold"></span>) sedang menunggu persetujuan admin.</p>
                <p class="text-blue-200 mb-8">Silakan hubungi admin untuk verifikasi. Anda akan diizinkan masuk setelah akun Anda disetujui.</p>
                <button id="pending-logout-button" class="w-full bg-white/20 hover:bg-white/30 border border-white/30 text-white font-bold py-3 px-4 rounded-full transition-colors duration-300 text-lg">Keluar</button>
            </div>
            <!-- AKHIR BARU -->
        </div>
        
        <p id="auth-switch-container" class="text-center text-blue-200 text-xs mt-6"> <!-- ID BARU DITAMBAHKAN -->
            <span id="auth-switch-text">Belum punya akun?</span>
            <button id="auth-switch-button" class="font-bold hover:underline transition-colors duration-200">Daftar Sekarang</button>
        </p>
    </div>
</div>

    
<div id="app-page" class="hidden">
        <div class="min-h-screen w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 pb-24">
            <header class="mb-8 p-6 rounded-3xl bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div>
                        <h1 id="header-title" class="text-3xl font-extrabold text-center sm:text-left">Temukan</h1>
                        <p id="header-subtitle" class="mt-1 text-blue-200 text-center sm:text-left">Selamat datang kembali!</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <!-- START: MODIFIKASI HEADER (Menambahkan Market Mode Select) -->
                        <select id="market-mode-select" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-3 rounded-full transition-colors duration-300 text-sm">
                            <option value="stock">Saham (BEI)</option>
                            <option value="crypto">Kripto (Global)</option>
                        </select>
                        <!-- END: MODIFIKASI HEADER -->
                        <label for="dark-mode-toggle" class="relative">
                            <input type="checkbox" id="dark-mode-toggle" class="toggle-checkbox">
                            <div class="toggle-switch">
                                <div class="toggle-switch-thumb"></div>
                            </div>
                        </label>
                        <button id="logout-button" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-5 rounded-full transition-colors duration-300">Keluar</button>
                    </div>
                </div>
            </header>

            
<main>
                <div id="discovery-tab-content">
                    <div class="max-w-5xl mx-auto">
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <nav class="flex -mb-px justify-around" aria-label="Tabs">
                                <button class="sub-tab-btn w-1/4 py-4 px-1 text-center text-sm font-medium" data-target="screener-sub-content">Screener</button>
                                <button class="sub-tab-btn w-1/4 py-4 px-1 text-center text-sm font-medium" data-target="discount-hunter-sub-content">Diskon</button>
                                <button class="sub-tab-btn w-1/4 py-4 px-1 text-center text-sm font-medium" data-target="investor-style-sub-content">Gaya Investor</button>
                                <button class="sub-tab-btn w-1/4 py-4 px-1 text-center text-sm font-medium" data-target="ipo-analysis-sub-content">IPO</button>
                            </nav>
                        </div>

                        <div id="screener-sub-content">
                            <div class="card p-6 mb-8">
                                <h2 class="text-xl font-bold text-center mb-6">Smart Screener</h2>
                                <div class="space-y-6">
                                    <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center items-center gap-4">
                                        <select id="sector-select" class="w-full sm:w-auto custom-select bg-gray-100 border border-gray-300 text-sm rounded-full focus:ring-blue-500 focus:border-blue-500 block p-3">
                                            <option selected value="semua">Semua Sektor</option>
                                        </select>
                                        <select id="risk-profile-select" class="w-full sm:w-auto custom-select bg-gray-100 border border-gray-300 text-sm rounded-full focus:ring-blue-500 focus:border-blue-500 block p-3">
                                            <option selected value="semua">Semua Profil Risiko</option>
                                            <option value="stabil">Aman & Stabil</option>
                                            <option value="pertumbuhan">Pertumbuhan Cepat</option>
                                        </select>
                                        <div class="w-full sm:w-auto flex items-center justify-center">
                                            <label for="multibagger-toggle" class="font-semibold mr-3">Multibagger</label>
                                            <label class="relative">
                                                <input type="checkbox" id="multibagger-toggle" class="toggle-checkbox">
                                                <div class="toggle-switch">
                                                    <div class="toggle-switch-thumb"></div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="relative">
                                        <textarea id="ai-prompt-input" rows="3" class="w-full bg-gray-100 border border-gray-300 text-sm rounded-2xl focus:ring-blue-500 focus:border-blue-500 block p-4" placeholder="Masukkan kriteria spesifik Anda di sini... (opsional)&#10;Contoh: saham yang diuntungkan dari pelemahan rupiah"></textarea>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Atau coba topik tren ini:</p>
                                        <div id="trending-topics-container" class="flex flex-wrap justify-center gap-2">
                                            <button class="trending-topic-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 font-semibold py-1.5 px-3 rounded-full">Potensi Nikel & EV</button>
                                            <button class="trending-topic-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 font-semibold py-1.5 px-3 rounded-full">Musim Dividen</button>
                                            <button class="trending-topic-btn text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 font-semibold py-1.5 px-3 rounded-full">Infrastruktur IKN</button>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <button id="screener-button" class="w-full sm:w-auto bg-gradient-to-r from-blue-500 to-indigo-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg">
                                            <ion-icon name="sparkles-outline" class="mr-2"></ion-icon>Cari dengan AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="screener-results-container" class="space-y-4"></div>
                        </div>

                        <div id="discount-hunter-sub-content" class="hidden">
                            <div class="card p-6 mb-8">
                                <h2 class="text-xl font-bold text-center mb-4">Pemburu Diskon</h2>
                                <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center items-center gap-4">
                                     <select id="discount-sector-select" class="w-full sm:w-auto custom-select bg-gray-100 border border-gray-300 text-sm rounded-full focus:ring-blue-500 focus:border-blue-500 block p-3">
                                        <option selected value="semua">Semua Sektor</option>
                                    </select>
                                    <button id="find-discount-button" class="w-full sm:w-auto bg-gradient-to-r from-cyan-500 to-sky-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg">Cari Peluang</button>
                                </div>
                            </div>
                            <div id="discount-hunter-results-container" class="space-y-4"></div>
                        </div>

                        <div id="investor-style-sub-content" class="hidden">
                             <div class="card p-6 mb-8 text-center">
                                <h2 class="text-xl font-bold mb-4">Gaya Investor</h2>
                                <p class="text-gray-500 dark:text-gray-400 mb-6">Tiru strategi investor idola Anda dan temukan saham yang cocok dengan gaya investasi mereka.</p>
                                <button id="open-investor-modal-button" class="bg-gradient-to-r from-purple-500 to-violet-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300">Pilih Investor Panutan</button>
                            </div>
                            <div id="benchmark-results-container" class="space-y-4"></div>
                        </div>

                        <div id="ipo-analysis-sub-content" class="hidden">
                            <div class="card p-6">
                                <h2 class="text-2xl font-bold text-center mb-4">Analisis IPO Mendatang</h2>
                                <div class="max-w-3xl mx-auto text-center mb-6">
                                    <p class="text-gray-500 dark:text-gray-400">Dapatkan analisis AI untuk saham yang akan melantai di bursa.</p>
                                </div>
                                <div id="ipo-analysis-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                                <div id="load-more-ipo-container" class="text-center mt-6">
                                    <button id="load-more-ipo-btn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-bold py-2 px-5 rounded-full transition-colors duration-300">Muat Lebih Banyak</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="strategy-lab-tab-content" class="hidden">
                    <div class="max-w-5xl mx-auto">
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <nav class="flex -mb-px justify-center" aria-label="Tabs">
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="ai-recommendation-sub-content">
                                    Rekomendasi AI
                                </button>
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="manual-portfolio-sub-content">
                                    Buat Portofolio Manual
                                </button>
                            </nav>
                        </div>

                        <div id="ai-recommendation-sub-content">
                            <div class="card p-6 mb-8">
                                <h2 class="text-xl font-bold text-center mb-2">Lab Strategi AI</h2>
                                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Dapatkan rekomendasi portofolio dari AI berdasarkan tujuan Anda.</p>
                                <div class="space-y-4">
                                    <div>
                                        <label for="virtual-capital" class="block mb-2 text-sm font-medium">Modal Virtual (Rp)</label>
                                        <input type="text" id="virtual-capital" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: 10.000.000" value="10.000.000">
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="profit-target" class="block mb-2 text-sm font-medium">Target Keuntungan (%)</label>
                                            <input type="number" id="profit-target" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: 25" value="25">
                                        </div>
                                        <div>
                                            <label for="investment-duration" class="block mb-2 text-sm font-medium">Durasi Investasi</label>
                                            <div class="flex gap-2">
                                                <input type="number" id="investment-duration-value" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" value="1">
                                                <select id="investment-duration-unit" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                                    <option value="bulan">Bulan</option>
                                                    <option value="tahun" selected>Tahun</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="risk-tolerance" class="block mb-2 text-sm font-medium">Toleransi Risiko (%)</label>
                                        <input type="number" id="risk-tolerance" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: 20" value="20">
                                    </div>
                                    <div>
                                        <label for="focus-sector" class="block mb-2 text-sm font-medium">Fokus Sektor/Tema (Opsional)</label>
                                        <input type="text" id="focus-sector" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: Teknologi dan EV">
                                    </div>
                                    <div class="text-center pt-4">
                                        <button id="generate-strategy-btn" class="w-full sm:w-auto bg-gradient-to-r from-teal-500 to-cyan-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg">
                                            <ion-icon name="construct-outline" class="mr-2"></ion-icon>Buat Rekomendasi
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="strategy-results-container"></div>
                        </div>

                        <div id="manual-portfolio-sub-content" class="hidden">
                             <div class="card p-6 mb-8">
                                <h2 class="text-xl font-bold text-center mb-2">Buat Portofolio Manual</h2>
                                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Masukkan saham pilihan Anda untuk dilacak sebagai portofolio virtual.</p>
                                <div class="mb-4">
                                    <label for="manual-portfolio-name" class="block mb-2 text-sm font-medium">Nama Portofolio</label>
                                    <input type="text" id="manual-portfolio-name" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: Portofolio Jangka Panjang">
                                </div>
                                <!-- MODIFIED: Tambahkan tooltip penjelasan Lot -->
                                <div class="mb-4">
                                    <label for="manual-virtual-capital" class="block mb-2 text-sm font-medium flex items-center gap-2">
                                        Modal Virtual (Rp) 
                                        <button type="button" class="text-blue-500 hover:text-blue-600" onclick="showLotInfoModal()">
                                            <ion-icon name="information-circle-outline"></ion-icon>
                                        </button>
                                    </label>
                                    <input type="text" id="manual-virtual-capital" class="strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Contoh: 10.000.000" value="10.000.000">
                                </div>
                                <!-- END MODIFIED -->
                                <div id="manual-portfolio-input-rows" class="space-y-3 mb-4">
                                    <div class="flex items-center gap-2">
                                        <input type="text" class="portfolio-ticker strategy-input uppercase bg-gray-100 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Ticker Saham (Contoh: BBCA)">
                                        <input type="number" class="portfolio-allocation strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg block w-32 p-2.5" placeholder="Alokasi %">
                                        <button class="remove-row-btn text-red-500 hover:text-red-700 p-2"><ion-icon name="trash-outline" class="text-xl"></ion-icon></button>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <button id="add-manual-row-btn" class="text-sm text-blue-600 font-semibold flex items-center gap-1"><ion-icon name="add-circle-outline"></ion-icon> Tambah Saham</button>
                                    <button id="save-manual-portfolio-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:opacity-90 text-white font-bold py-2 px-6 rounded-full">
                                        <ion-icon name="save-outline" class="mr-2"></ion-icon>Simpan & Lacak
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="track-tab-content" class="hidden">
                    <div class="max-w-5xl mx-auto">
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <nav class="flex -mb-px justify-center" aria-label="Tabs">
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="portfolio-sub-content">Portofolio Saya</button>
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="watchlist-sub-content">Watchlist</button>
                            </nav>
                        </div>
                        <div id="portfolio-sub-content">
                            <div id="portfolios-container" class="space-y-6"></div>
                            <div id="health-check-results-container" class="mt-8"></div>
                        </div>
                        <div id="watchlist-sub-content" class="hidden">
                            <div id="watchlist-summary-container" class="mb-6"></div>
                            <div class="flex justify-center mb-6">
                                <button id="get-watchlist-summary-btn" class="bg-gradient-to-r from-indigo-500 to-purple-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg">
                                    <ion-icon name="newspaper-outline" class="mr-2"></ion-icon>Dapatkan Ringkasan Harian AI
                                </button>
                            </div>
                            <div id="watchlist-results-container" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <div id="analysis-tab-content" class="hidden">
                    <!-- FITUR BARU: Sub-tab untuk Analisis dan Bandingkan -->
                    <div class="max-w-5xl mx-auto">
                        <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                            <nav class="flex -mb-px justify-center" aria-label="Tabs">
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="direct-analysis-sub-content">Analisis Langsung</button>
                                <button class="sub-tab-btn w-1/2 py-4 px-1 text-center text-sm font-medium" data-target="compare-stocks-sub-content">Bandingkan Saham</button>
                            </nav>
                        </div>

                        <div id="direct-analysis-sub-content">
                            <!-- START: BLOK PENCARIAN DIPINDAHKAN KE ATAS DAN SELALU TERLIHAT -->
                            <div class="mt-4 mb-8 max-w-lg mx-auto">
                                <label for="direct-analysis-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" id="direct-analysis-label">Analisis Saham Secara Langsung</label>
                                <div class="mt-1 flex rounded-full shadow-md">
                                    <input type="text" id="direct-analysis-input" class="w-full uppercase bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-l-full p-3 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan Ticker (Contoh: BBCA)">
                                    <button id="direct-analysis-btn" class="bg-blue-600 text-white px-6 rounded-r-full hover:bg-blue-700 flex items-center justify-center transition-colors">
                                        <ion-icon name="search-outline" class="text-xl"></ion-icon>
                                    </button>
                                </div>
                            </div>
                            <!-- END: BLOK PENCARIAN DIPINDAHKAN KE ATAS DAN SELALU TERLIHAT -->

                            <div id="analysis-placeholder" class="text-center text-gray-500 dark:text-gray-400 py-16">
                                <ion-icon name="analytics-outline" class="text-6xl mx-auto"></ion-icon>
                                <p class="text-lg mt-4">Pilih saham dari tab lain untuk dianalisis, atau gunakan kolom di atas.</p>
                            </div>

                            <div id="analysis-results-container" class="hidden">
                                <h2 id="stock-name" class="text-3xl font-bold text-center mb-6"></h2>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div class="lg:col-span-2 card p-4">
                                        <h3 class="text-xl font-semibold mb-4">Grafik Harga</h3>
                                        <div id="technical-chart-container" class="w-full h-[450px]"></div>
                                    </div>
                                    <div class="lg:col-span-1 space-y-6">
                                        <div class="card p-4">
                                            <h3 class="text-xl font-semibold mb-4">Proyeksi Harga</h3>
                                            <div id="projection-container"><div class="flex justify-center p-4"><div class="loader"></div></div></div>
                                        </div>
                                        <div class="card p-4">
                                            <h3 class="text-xl font-semibold mb-4">Profil & Fundamental</h3>
                                            <div id="company-profile-container"><div class="flex justify-center p-4"><div class="loader"></div></div></div>
                                            <div id="fundamental-data-container" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700"><div class="flex justify-center p-4"><div class="loader"></div></div></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="investor-checklist-section" class="mt-6 card p-6">
                                     <!-- Checklist will be inserted here -->
                                </div>

                                <div class="mt-6 card p-6">
                                    <h3 class="text-2xl font-bold text-center mb-4">Analisis Komprehensif AI</h3>
                                    <div id="advanced-output-container">
                                        <p class="text-center text-gray-500 dark:text-gray-400">Lengkapi checklist di atas dan klik tombol di bawah untuk mendapatkan analisis mendalam dari AI.</p>
                                    </div>
                                    <div class="text-center mt-6">
                                        <button id="run-advanced-analysis-button" class="bg-gradient-to-r from-green-500 to-teal-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 inline-flex items-center justify-center text-lg disabled:opacity-50" disabled>
                                            <ion-icon name="sparkles-outline" class="mr-2"></ion-icon>
                                            Jalankan Analisis AI
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-6 card p-6">
                                    <h3 class="text-2xl font-bold text-center mb-4">Debat Bull vs. Bear</h3>
                                    <div id="debate-results-container" class="text-center text-gray-500 dark:text-gray-400">
                                        <p>Dapatkan dua sisi argumen dari AI untuk membuat keputusan yang lebih matang.</p>
                                    </div>
                                    <div class="text-center mt-6">
                                        <button id="start-debate-btn" class="bg-gradient-to-r from-orange-500 to-red-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 inline-flex items-center justify-center text-lg">
                                            <ion-icon name="git-compare-outline" class="mr-2"></ion-icon>
                                            Mulai Debat AI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FITUR BARU: Konten untuk Bandingkan Saham -->
                        <div id="compare-stocks-sub-content" class="hidden">
                            <div class="card p-6 mb-8">
                                <h2 class="text-xl font-bold text-center mb-2" id="compare-stocks-title">Bandingkan Saham</h2>
                                <p class="text-center text-gray-500 dark:text-gray-400 mb-6" id="compare-stocks-subtitle">Masukkan 2 atau 3 ticker saham untuk melihat perbandingan fundamental dan analisis AI.</p>
                                <div id="compare-inputs-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                                    <input type="text" class="compare-input uppercase bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ticker 1 (Contoh: BBCA)">
                                    <input type="text" class="compare-input uppercase bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ticker 2 (Contoh: BBRI)">
                                    <input type="text" class="compare-input uppercase bg-gray-100 border border-gray-300 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="Ticker 3 (Opsional)">
                                </div>
                                <div class="text-center">
                                    <button id="compare-stocks-btn" class="w-full sm:w-auto bg-gradient-to-r from-pink-500 to-rose-500 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg">
                                        <ion-icon name="git-compare-outline" class="mr-2"></ion-icon>Bandingkan
                                    </button>
                                </div>
                            </div>
                            <div id="compare-results-container"></div>
                        </div>
                    </div>
                </div>

                <div id="education-tab-content" class="hidden">
                    <div id="education-app" class="container mx-auto max-w-5xl"></div>
                </div>

            </main>
        </div>
        
        <!-- Navigasi Bawah untuk Mobile -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)] flex justify-around z-10">
            <button data-tab="discovery" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-2">
                <ion-icon name="compass-outline" class="text-2xl"></ion-icon>
                <span class="text-xs">Temukan</span>
            </button>
            <button data-tab="strategyLab" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-2">
                <ion-icon name="flask-outline" class="text-2xl"></ion-icon>
                <span class="text-xs">Lab</span>
            </button>
            <button data-tab="track" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-2">
                <ion-icon name="folder-open-outline" class="text-2xl"></ion-icon>
                <span class="text-xs">Lacak</span>
            </button>
            <button data-tab="analysis" class="bottom-nav-btn flex-1 flex flex-col items-center justify-center p-2">
                <ion-icon name="analytics-outline" class="text-2xl"></ion-icon>
                <span class="text-xs">Analisis</span>
            </button>
        </nav>
    </div>
    
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // Konstanta Global yang sudah tersedia
        const __firebase_config = '{"apiKey":"AIzaSyCCV7FD5FQqVW1WnP-Zu6UWAhAz19dthso","authDomain":"analisahamku.firebaseapp.com","projectId":"analisahamku","storageBucket":"analisahamku.appspot.com","messagingSenderId":"503947258604","appId":"1:503947258604:web:f5b10c998ce395405413c9","databaseURL":"https://analisahamku-default-rtdb.asia-southeast1.firebasedatabase.app"}';
        const __app_id = "default-app-id";
        
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);
        
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authError = document.getElementById('auth-error');
        const authSwitchText = document.getElementById('auth-switch-text');
        const authSwitchButton = document.getElementById('auth-switch-button');

        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginFormContent = document.getElementById('login-form-content');
        const registerFormContent = document.getElementById('register-form-content');
        const forgotPasswordButton = document.getElementById('forgot-password-button');
        
        let authMode = 'login'; // 'login' atau 'register'

        function setAuthMode(mode) {
            authMode = mode;
            authError.classList.add('hidden');
            if (authMode === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.textContent = 'Selamat Datang';
                authSubtitle.textContent = 'Masuk ke Akun Anda';
                authSwitchText.textContent = 'Belum punya akun?';
                authSwitchButton.textContent = 'Daftar Sekarang';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'Daftar Akun Baru';
                authSubtitle.textContent = 'Isi data Anda untuk mendaftar';
                authSwitchText.textContent = 'Sudah punya akun?';
                authSwitchButton.textContent = 'Masuk Sekarang';
            }
        }
        
        authSwitchButton.addEventListener('click', () => {
            if (authMode === 'login') {
                setAuthMode('register');
            } else {
                setAuthMode('login');
            }
        });

        loginFormContent.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // BARU: Tambahkan State Loading
            const loginButton = document.getElementById('login-button');
            const originalButtonText = loginButton.innerHTML;
            loginButton.disabled = true;
            loginButton.innerHTML = `<div class="flex justify-center items-center gap-2"><div class="mini-loader" style="border-left-color: #3b82f6;"></div><span>Masuk...</span></div>`;
            // AKHIR BARU
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Biarkan tombol disabled, onAuthStateChanged akan mengambil alih
            } catch (error) {
                let errorMessage = "Gagal masuk. Periksa email atau kata sandi Anda.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Email tidak terdaftar.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = "Kata sandi salah.";
                }
                authError.textContent = errorMessage;
                authError.classList.remove('hidden');
                
                // BARU: Kembalikan tombol jika error
                loginButton.disabled = false;
                loginButton.innerHTML = originalButtonText;
                // AKHIR BARU
            }
        });
        
        registerFormContent.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // BARU: Tambahkan State Loading
            const registerButton = document.getElementById('register-button');
            const originalButtonText = registerButton.innerHTML;
            registerButton.disabled = true;
            registerButton.innerHTML = `<div class="flex justify-center items-center gap-2"><div class="mini-loader" style="border-left-color: #3b82f6;"></div><span>Mendaftar...</span></div>`;
            // AKHIR BARU
            
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-password-confirm').value;
            authError.classList.add('hidden');
            
            if (password !== confirmPassword) {
                authError.textContent = "Kata sandi tidak cocok.";
                authError.classList.remove('hidden');
                return;
            }
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // MODIFIKASI: Simpan profil DAN status
                const userRef = ref(database, `users/${user.uid}`);
                await set(userRef, { 
                    profile: { 
                        name: name, 
                        email: email 
                    },
                    status: "pending" // <-- INI DIA PERUBAHAN UTAMANYA
                });
                
                // Setelah pendaftaran berhasil, pengguna akan langsung masuk
                // dan onAuthStateChanged akan menangani status "pending" mereka.
            } catch (error) {
                let errorMessage = "Pendaftaran gagal. Coba lagi.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email sudah digunakan.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Kata sandi terlalu lemah.";
                }
                authError.textContent = errorMessage;
                authError.classList.remove('hidden');
                
                // BARU: Kembalikan tombol jika error
                registerButton.disabled = false;
                registerButton.innerHTML = originalButtonText;
                // AKHIR BARU
            }
        });

        forgotPasswordButton.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            if (!email) {
                showModal("Input Tidak Lengkap", "Masukkan email untuk mereset kata sandi.");
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showModal("Link Terkirim", "Link reset kata sandi telah dikirim ke email Anda. Silakan periksa kotak masuk Anda.");
            } catch (error) {
                let errorMessage = "Gagal mengirim link reset. Periksa kembali email Anda.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = "Email tidak terdaftar.";
                }
                showModal("Error", errorMessage);
            }
        });

        // MODIFIKASI BESAR: Logika "Gatekeeper"
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Pengguna sudah login, CEK STATUS MEREKA
                const userId = user.uid;
                // MODIFIKASI: Ambil seluruh data pengguna, bukan hanya status
                const userRef = ref(database, `users/${userId}`);
                
                let status = null;
                let expiresAt = null; // BARU: Variabel untuk menyimpan waktu kedaluwarsa

                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        status = userData.status;
                        expiresAt = userData.expiresAt || null; // Ambil expiresAt, default ke null
                    }
                } catch (error) {
                    console.error("Gagal mengambil status pengguna:", error);
                    status = "error"; // Asumsikan error jika gagal fetch
                }

                if (status === "verified") {
                    // --- KASUS 1: DISETUJUI ---
                    
                    // BARU: Periksa tanggal kedaluwarsa
                    const isLifetime = (expiresAt === null);
                    const isExpired = (!isLifetime && Date.now() > expiresAt);

                    if (isLifetime || !isExpired) {
                        // KASUS 1A: Akses Diberikan (Lifetime atau Belum Kedaluwarsa)
                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        initializeStockApp(userId);

                    } else if (isExpired) {
                        // KASUS 1B: Kedaluwarsa
                        // Set status mereka kembali ke 'pending' agar admin bisa approve lagi
                        await set(ref(database, `users/${userId}/status`), "pending");

                        // Tampilkan form login, sembunyikan pending/register
                        setAuthMode('login'); 
                        document.getElementById('auth-switch-container').classList.remove('hidden');
                        document.getElementById('pending-form').classList.add('hidden');
                        
                        // Tampilkan error kedaluwarsa
                        authError.textContent = "Akses Anda telah kedaluwarsa. Silakan hubungi admin.";
                        authError.classList.remove('hidden');
                        
                        // Log out pengguna
                        await auth.signOut();
                    }

                } else if (status === "pending") {
                    // --- KASUS 2: PENDING ---
                    loginPage.classList.remove('hidden'); // Tampilkan halaman login
                    appPage.classList.add('hidden'); // Sembunyikan aplikasi
                    
                    // Sembunyikan form login/register dan tombol switch
                    loginForm.classList.add('hidden');
                    registerForm.classList.add('hidden');
                    document.getElementById('auth-switch-container').classList.add('hidden');
                    authError.classList.add('hidden');
                    
                    // Tampilkan pesan "Pending"
                    const pendingForm = document.getElementById('pending-form');
                    pendingForm.classList.remove('hidden');
                    document.getElementById('pending-email').textContent = user.email;
                    
                    // Tambahkan listener ke tombol logout di-sini
                    // Kita perlu clone dan replace untuk memastikan listener lama terhapus
                    const pendingLogoutBtn = document.getElementById('pending-logout-button');
                    pendingLogoutBtn.replaceWith(pendingLogoutBtn.cloneNode(true));
                    document.getElementById('pending-logout-button').addEventListener('click', () => {
                        auth.signOut();
                    });

                } else {
                    // --- KASUS 3: DITOLAK / ERROR / BELUM ADA STATUS ---
                    // Asumsikan semua status lain tidak boleh masuk.
                    // Tampilkan pesan error di halaman login dan log out.
                    
                    // Tampilkan form login, sembunyikan pending/register
                    setAuthMode('login'); 
                    document.getElementById('auth-switch-container').classList.remove('hidden');
                    document.getElementById('pending-form').classList.add('hidden');
                    
                    // Tampilkan error
                    let errorMessage = "Akun Anda belum terverifikasi oleh admin.";
                    if (status === "error") {
                        errorMessage = "Gagal memverifikasi status akun Anda. Coba lagi.";
                    } else if (status === "rejected") {
                        errorMessage = "Pendaftaran Anda ditolak.";
                    }
                    
                    authError.textContent = errorMessage;
                    authError.classList.remove('hidden');
                    
                    // Log out pengguna agar tidak terjebak
                    await auth.signOut();
                }

            } else {
                // --- KASUS 4: TIDAK ADA PENGGUNA (LOGGED OUT) ---
                loginPage.classList.remove('hidden');
                appPage.classList.add('hidden');
                
                // Pastikan UI login dalam keadaan normal (form login terlihat)
                setAuthMode('login');
                document.getElementById('auth-switch-container').classList.remove('hidden');
                document.getElementById('pending-form').classList.add('hidden');
            }
        });

        function initializeStockApp(userId) {
            const logoutButton = document.getElementById('logout-button');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const marketModeSelect = document.getElementById('market-mode-select'); // NEW ID
            const htmlTag = document.documentElement;
            
            let currentAnalysisTicker = null;
        let currentMarketMode = marketModeSelect.value; // NEW VARIABLE
        let selectedInvestor = null;
        let displayedIpoCount = 0;
        const ipoBatchSize = 4;
        
        function setDarkMode(isDark) {
                if (isDark) {
                    htmlTag.classList.add('dark');
                    document.body.classList.add('dark');
                } else {
                    htmlTag.classList.remove('dark');
                    document.body.classList.remove('dark');
                }
                localStorage.setItem('darkMode', isDark);
                if (currentAnalysisTicker && document.getElementById('technical-chart-container').offsetParent !== null) {
                    // Update widget saat mode berubah (jika widget aktif)
                    displayTradingViewWidget(currentAnalysisTicker, 'technical-chart-container');
                }
            }

            if (localStorage.getItem('darkMode') === 'true') {
                darkModeToggle.checked = true;
                setDarkMode(true);
            } else {
                setDarkMode(false);
            }

            darkModeToggle.addEventListener('change', () => {
                setDarkMode(darkModeToggle.checked);
            });
            
            // START: LOGIKA BARU UNTUK SWITCH MODE PASAR
            function updateMarketMode(newMode) {
                currentMarketMode = newMode;
                marketModeSelect.value = newMode; // Ensure select box matches state
                localStorage.setItem('marketMode', newMode);
                
                // Panggil fungsi UI update
                updateMarketUI(newMode);
                
                // Bersihkan tampilan jika di tab analisis dan ganti mode
                if (currentAnalysisTicker && document.getElementById('analysis-tab-content').offsetParent !== null) {
                    currentAnalysisTicker = null; // Reset current ticker
                    analysisPlaceholder.classList.remove('hidden');
                    analysisResultsContainer.classList.add('hidden');
                }
            }

            function updateMarketUI(mode) {
                const isCrypto = mode === 'crypto';
                
                // 1. Update Teks Tampilan
                document.getElementById('direct-analysis-label').textContent = isCrypto ? 'Analisis Kripto Secara Langsung' : 'Analisis Saham Secara Langsung';
                document.getElementById('direct-analysis-input').placeholder = isCrypto ? 'Masukkan Ticker Kripto (Contoh: BTC-USD)' : 'Masukkan Ticker Saham (Contoh: BBCA)';
                document.getElementById('compare-stocks-title').textContent = isCrypto ? 'Bandingkan Kripto' : 'Bandingkan Saham';
                document.getElementById('compare-stocks-subtitle').textContent = isCrypto ? 'Masukkan 2 atau 3 ticker kripto untuk melihat perbandingan dan analisis AI.' : 'Masukkan 2 atau 3 ticker saham untuk melihat perbandingan fundamental dan analisis AI.';
                
                // 2. Tampilkan/Sembunyikan Tab Khusus Saham
                document.querySelector('[data-target="ipo-analysis-sub-content"]').closest('button').classList.toggle('hidden', isCrypto);
                
                // 3. Update Placeholder Input Bandingkan
                document.querySelectorAll('.compare-input').forEach((input, index) => {
                    if (isCrypto) {
                        input.placeholder = (index === 0) ? 'Ticker 1 (Contoh: BTC-USD)' : ((index === 1) ? 'Ticker 2 (Contoh: ETH-USD)' : 'Ticker 3 (Opsional)');
                    } else {
                        input.placeholder = (index === 0) ? 'Ticker 1 (Contoh: BBCA)' : ((index === 1) ? 'Ticker 2 (Contoh: BBRI)' : 'Ticker 3 (Opsional)');
                    }
                });
                
                // 4. Perbarui Label Modal Virtual
                const lotLabel = document.querySelector('#manual-portfolio-sub-content label[for="manual-virtual-capital"]');
                if (lotLabel) {
                    const infoButton = lotLabel.querySelector('button');
                    lotLabel.innerHTML = isCrypto 
                        ? 'Modal Virtual (Rp)' 
                        : 'Modal Virtual (Rp) ';
                    if (infoButton && !isCrypto) {
                         lotLabel.appendChild(infoButton); // Hanya tampilkan Lot info di mode Saham
                    }
                }
            }
            
            marketModeSelect.addEventListener('change', (e) => {
                updateMarketMode(e.target.value);
            });
            
            // Set initial mode from localStorage or default
            const initialMarketMode = localStorage.getItem('marketMode') || 'stock';
            updateMarketMode(initialMarketMode);
            // END: LOGIKA BARU UNTUK SWITCH MODE PASAR

            logoutButton.addEventListener('click', async () => {
                await auth.signOut();
                window.location.reload();
            });
            
            const investors = [
                { id: 'lkh', name: 'Lo Kheng Hong', style: 'Value investing dengan fokus pada valuasi sangat murah (PBV/PER rendah) dan fundamental kuat. Sering disebut Warren Buffett-nya Indonesia.' },
                { id: 'warren_buffett', name: 'Warren Buffett', style: 'Investasi jangka panjang pada perusahaan berkualitas tinggi dengan keunggulan kompetitif yang tahan lama (moat) dan membelinya dengan harga wajar.' },
                { id: 'peter_lynch', name: 'Peter Lynch', style: 'Investasi pada perusahaan yang produknya mudah dipahami ("invest in what you know") dan memiliki potensi pertumbuhan tinggi, seringkali di kategori "growth at a reasonable price" (GARP).' },
                { id: 'benjamin_graham', name: 'Benjamin Graham', style: 'Bapak value investing, fokus pada margin of safety, yaitu membeli saham jauh di bawah nilai intrinsiknya untuk meminimalisir risiko.' },
                { id: 'robert_budi_hartono', name: 'Robert Budi Hartono', style: 'Investasi jangka panjang di sektor-sektor dominan seperti perbankan (contohnya BCA) dan barang konsumen yang memiliki pangsa pasar besar.' },
                { id: 'michael_hartono', name: 'Michael Hartono', style: 'Mirip dengan saudaranya, fokus pada investasi jangka panjang di sektor perbankan dan barang konsumen yang sudah mapan.' },
                { id: 'chairul_tanjung', name: 'Chairul Tanjung', style: 'Membangun konglomerasi di berbagai sektor seperti media, ritel, dan keuangan, seringkali melalui akuisisi dan sinergi antar bisnis.' },
                { id: 'prajogo_pangestu', name: 'Prajogo Pangestu', style: 'Fokus pada sektor-sektor industri berat seperti petrokimia dan energi (contohnya Barito Pacific, Chandra Asri), seringkali dengan ekspansi bisnis yang agresif.' },
                { id: 'anthoni_salim', name: 'Anthoni Salim', style: 'Mengelola konglomerasi besar di sektor makanan (Indofood), telekomunikasi, dan ritel, dengan strategi diversifikasi yang luas.' },
                { id: 'cathie_wood', name: 'Cathie Wood', style: 'Investasi pada inovasi disruptif di sektor teknologi, genomik, dan blockchain (melalui ARK Invest), dengan toleransi risiko yang tinggi untuk potensi pertumbuhan eksponensial.' },
                { id: 'saratoga_investama', name: 'Saratoga Investama Sedaya', style: 'Perusahaan investasi aktif dengan portofolio terdiversifikasi di sektor-sektor kunci seperti infrastruktur, sumber daya alam, dan konsumen.' },
        ];
        
        let fetchedIpoList = []; 
        let watchlist = [];

        const tabs = {
            discovery: { content: document.getElementById('discovery-tab-content'), title: 'Temukan Peluang', subtitle: 'Cari ide saham terbaik untuk Anda.' },
                strategyLab: { content: document.getElementById('strategy-lab-tab-content'), title: 'Lab Strategi', subtitle: 'Rancang & simpan portofolio virtual Anda.' },
                track: { content: document.getElementById('track-tab-content'), title: 'Lacak Investasi', subtitle: 'Pantau portofolio dan watchlist Anda.' },
                analysis: { content: document.getElementById('analysis-tab-content'), title: 'Analisis Saham', subtitle: 'Dapatkan analisis mendalam untuk saham pilihan.' },
            };

            const bottomNavButtons = document.querySelectorAll('.bottom-nav-btn');
            const analysisPlaceholder = document.getElementById('analysis-placeholder');
            const analysisResultsContainer = document.getElementById('analysis-results-container');
            const stockName = document.getElementById('stock-name');
            const technicalChartContainer = document.getElementById('technical-chart-container');
            const projectionContainer = document.getElementById('projection-container');
            const companyProfileContainer = document.getElementById('company-profile-container');
            const fundamentalDataContainer = document.getElementById('fundamental-data-container');
            const screenerButton = document.getElementById('screener-button');
            const screenerResultsContainer = document.getElementById('screener-results-container');
            const sectorSelect = document.getElementById('sector-select');
            const riskProfileSelect = document.getElementById('risk-profile-select');
            const multibaggerToggle = document.getElementById('multibagger-toggle');
            const benchmarkResultsContainer = document.getElementById('benchmark-results-container');
            const advancedOutputContainer = document.getElementById('advanced-output-container');
            const findDiscountButton = document.getElementById('find-discount-button');
            const discountHunterResultsContainer = document.getElementById('discount-hunter-results-container');
            const discountSectorSelect = document.getElementById('discount-sector-select');
            const openInvestorModalButton = document.getElementById('open-investor-modal-button');
            const modalContainer = document.getElementById('modal-container');
            const runAdvancedAnalysisButton = document.getElementById('run-advanced-analysis-button');
            const headerTitle = document.getElementById('header-title');
            const headerSubtitle = document.getElementById('header-subtitle');
            const ipoAnalysisContainer = document.getElementById('ipo-analysis-container');
            const investorChecklistSection = document.getElementById('investor-checklist-section');
            const loadMoreIpoBtn = document.getElementById('load-more-ipo-btn');
            const aiPromptInput = document.getElementById('ai-prompt-input');
            const trendingTopicButtons = document.querySelectorAll('.trending-topic-btn');
            const generateStrategyBtn = document.getElementById('generate-strategy-btn');
            const strategyResultsContainer = document.getElementById('strategy-results-container');
            const virtualCapitalInput = document.getElementById('virtual-capital');
            const addManualRowBtn = document.getElementById('add-manual-row-btn');
            const saveManualPortfolioBtn = document.getElementById('save-manual-portfolio-btn');
            const manualPortfolioInputRows = document.getElementById('manual-portfolio-input-rows');
            const healthCheckResultsContainer = document.getElementById('health-check-results-container');
            const startDebateBtn = document.getElementById('start-debate-btn');
            const debateResultsContainer = document.getElementById('debate-results-container');
            const getWatchlistSummaryBtn = document.getElementById('get-watchlist-summary-btn');
            const portfoliosContainer = document.getElementById('portfolios-container');
            const directAnalysisBtn = document.getElementById('direct-analysis-btn');
            const directAnalysisInput = document.getElementById('direct-analysis-input');
            const compareStocksBtn = document.getElementById('compare-stocks-btn');
            const manualVirtualCapitalInput = document.getElementById('manual-virtual-capital'); 
            
            // SECURITY FIX: Kunci API Gemini dipindahkan ke server Render Anda.
            // Panggil URL ini, dan server Anda harus menambahkan kunci API secara aman.
            const RENDER_AI_PROXY_URL = 'https://analisahamku-v2.onrender.com/api/gemini-proxy'; // Ganti dengan endpoint yang Anda buat
            
            // URL API Backend untuk data harga saham/kripto
            const PRICE_API_URL = 'https://stock-api-server-28ng.onrender.com/api/';

            function showModal(title, content, isChart = false) {
                const sizeClass = isChart ? 'max-w-4xl' : 'max-w-lg';
                const modalHTML = `
                    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50">
                        <div class="card w-full ${sizeClass}">
                            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                                <h3 class="text-xl font-semibold">${title}</h3>
                                <button id="close-modal-button" class="text-gray-400 hover:text-gray-800 dark:hover:text-white">
                                    <ion-icon name="close-outline" class="text-3xl"></ion-icon>
                                </button>
                            </div>
                            <div class="p-6 max-h-[80vh] overflow-y-auto">${content}</div>
                        </div>
                    </div>`;
                modalContainer.innerHTML = modalHTML;
                document.getElementById('close-modal-button').addEventListener('click', () => {
                    modalContainer.innerHTML = '';
                });
            }

            // NEW FUNCTION: Modal untuk penjelasan Lot
            function showLotInfoModal() {
                 showModal('Penting: Satuan Lot (100 Lembar)', `
                    <p class="mb-4">Perlu diperhatikan bahwa di Pasar Modal Indonesia (BEI), saham dibeli dan dijual dalam satuan **Lot**, di mana 1 Lot = 100 Lembar saham.</p>
                    <p class="mb-4">Ketika Anda memasukkan modal virtual, sistem akan menghitung berapa **Lot penuh** yang dapat dibeli dari uang yang dialokasikan (berdasarkan harga saham saat ini).</p>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-200 dark:border-blue-800">
                        <p class="font-semibold text-blue-800 dark:text-blue-200">Contoh:</p>
                        <ul class="list-disc pl-5 text-sm">
                            <li>Modal yang Dialokasikan: Rp 1.000.000</li>
                            <li>Harga Saham per Lembar: Rp 8.000</li>
                            <li>Harga 1 Lot: Rp 800.000</li>
                            <li>Maksimal Lot yang Bisa Dibeli: 1 Lot.</li>
                            <li>Modal Awal Portofolio: Hanya Rp 800.000.</li>
                            <li>Sisa Modal: Rp 200.000 tidak terpakai (karena tidak cukup untuk lot kedua).</li>
                        </ul>
                    </div>
                    <p class="mt-4 text-sm text-gray-500">Oleh karena itu, **Modal Awal** portofolio Anda mungkin sedikit lebih kecil dari **Modal Virtual** yang Anda input.</p>
                `);
            }
            // END NEW FUNCTION
            
            function showChartModal(ticker) {
                const title = `Grafik Harga: ${ticker}`;
                const content = `<div id="modal-chart-container" class="w-full h-[450px]"></div>`;
                showModal(title, content, true);
                displayTradingViewWidget(ticker, 'modal-chart-container');
            }
            
            openInvestorModalButton.addEventListener('click', () => {
                const modalContent = `
                    <input type="text" id="investor-search-input" placeholder="Cari nama investor..." class="investor-search-input w-full bg-gray-100 border border-gray-300 text-sm p-2 mb-4 rounded-full focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <div id="investor-list" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>`;
                showModal('Pilih Investor Panutan', modalContent);
                renderInvestorList();
                document.getElementById('investor-search-input').addEventListener('input', (e) => renderInvestorList(e.target.value.toLowerCase()));
            });
            
            function switchTab(activeKey) {
                Object.keys(tabs).forEach(key => {
                    const isActive = key === activeKey;
                    if(tabs[key].content) {
                        tabs[key].content.classList.toggle('hidden', !isActive);
                    }
                });
                bottomNavButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === activeKey));
                
                const activeTabInfo = tabs[activeKey];
                if (activeTabInfo) {
                    headerTitle.textContent = activeTabInfo.title;
                    headerSubtitle.textContent = activeTabInfo.subtitle;
                }

                if (activeKey === 'track') {
                    loadAndDisplayPortfolios();
                    renderWatchlistPage();
                }
                
                // Panggil update UI saat ganti tab (untuk memastikan visibilitas IPO)
                updateMarketUI(currentMarketMode);
            }
            
            bottomNavButtons.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
            
            if(screenerButton) screenerButton.addEventListener('click', handleScreenerClick);
            if(findDiscountButton) findDiscountButton.addEventListener('click', handleDiscountHunterClick);
            if(runAdvancedAnalysisButton) runAdvancedAnalysisButton.addEventListener('click', handleAdvancedAnalysisClick);
            trendingTopicButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    aiPromptInput.value = btn.textContent;
                });
            });
            if(generateStrategyBtn) generateStrategyBtn.addEventListener('click', handleStrategyGeneration);
            
            if(addManualRowBtn) addManualRowBtn.addEventListener('click', addManualPortfolioRow);
            if(saveManualPortfolioBtn) saveManualPortfolioBtn.addEventListener('click', handleSaveManualPortfolio);
            manualPortfolioInputRows.addEventListener('click', (e) => {
                if (e.target.closest('.remove-row-btn')) {
                    e.target.closest('.flex').remove();
                }
            });

            if(startDebateBtn) startDebateBtn.addEventListener('click', handleDebateGeneration);
            if(getWatchlistSummaryBtn) getWatchlistSummaryBtn.addEventListener('click', handleWatchlistSummary);

            if(directAnalysisBtn) {
                directAnalysisBtn.addEventListener('click', () => {
                    const ticker = directAnalysisInput.value.trim().toUpperCase();
                    if (ticker) {
                        handleFetchData(ticker);
                    }
                });
            }
            if(directAnalysisInput) {
                directAnalysisInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const ticker = directAnalysisInput.value.trim().toUpperCase();
                        if (ticker) {
                            handleFetchData(ticker);
                        }
                    }
                });
            }
            if(compareStocksBtn) compareStocksBtn.addEventListener('click', handleCompareStocks);

            // Logic to format Capital Inputs
            const formatCapitalInput = (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value) {
                    e.target.value = new Intl.NumberFormat('id-ID').format(value);
                } else {
                    e.target.value = '';
                }
            };
            virtualCapitalInput.addEventListener('input', formatCapitalInput);
            if (manualVirtualCapitalInput) {
                manualVirtualCapitalInput.addEventListener('input', formatCapitalInput);
            }
            // END Logic to format Capital Inputs

            function renderInvestorList(filter = '') {
                const investorListEl = document.getElementById('investor-list');
                if (!investorListEl) return;
                investorListEl.innerHTML = '';
                const filteredInvestors = investors.filter(inv => inv.name.toLowerCase().includes(filter));
                if (filteredInvestors.length === 0) {
                     investorListEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400 text-center">Tidak ditemukan.</p>`;
                     return;
                }
                filteredInvestors.forEach(investor => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg cursor-pointer';
                    item.textContent = investor.name;
                    item.addEventListener('click', () => {
                        selectedInvestor = investor;
                        openInvestorModalButton.textContent = investor.name;
                        modalContainer.innerHTML = ''; 
                        handleBenchmarkClick();
                    });
                    investorListEl.appendChild(item);
                });
            }
            
            // MODIFIED: Menggunakan currentMarketMode untuk menentukan ticker suffix dan API URL.
            async function triggerBackendFetch(ticker) {
                const isCrypto = currentMarketMode === 'crypto';
                
                // Tentukan suffix atau format ticker
                const finalTicker = isCrypto ? `${ticker.toUpperCase()}-USD` : `${ticker.toLowerCase()}.jk`;
                
                // Gunakan URL API yang sudah ada
                const apiUrl = PRICE_API_URL + finalTicker; 
                
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    
                    // Logika untuk Saham (Data yang diharapkan dari backend lama)
                    if (!isCrypto) {
                        const price = data?.chart?.result?.[0]?.meta?.regularMarketPrice;
                        const companyName = data?.chart?.result?.[0]?.meta?.instrumentDisplayName || ticker;
                        if (price === undefined) throw new Error("Price not found in API response structure (Stock).");
                        return { regularMarketPrice: price, companyName: companyName, aiAnalysis: `Data harga terbaru berhasil diambil dari server backend.` };
                    } 
                    // Logika untuk Kripto (Asumsi: backend mengembalikan data yang lebih sederhana)
                    else {
                        const price = data?.regularMarketPrice; // Asumsi backend mengembalikan struktur yang rata
                        const companyName = data?.shortName || ticker;
                        if (price === undefined) throw new Error("Price not found in API response structure (Crypto).");
                        return { regularMarketPrice: price, companyName: companyName, aiAnalysis: `Data harga Kripto berhasil diambil dari server backend.` };
                    }
                    
                } catch (error) {
                    console.error(`Failed to fetch data from Render backend for ${finalTicker}:`, error);
                    return null;
                }
            }
            // END MODIFIED

            // MODIFIED: Fungsi ini sekarang memanggil endpoint proxy aman di server Render Anda.
            // Anda harus mengimplementasikan endpoint /api/gemini-proxy di server Anda.
            async function fetchFromGemini(prompt, schema, retries = 3, delay = 1000) {
                
                // 1. Construct payload to be sent to the secure proxy server
                const clientPayload = { 
                    prompt: prompt,
                    // FIX: Kirim objek skema jika ada, bukan stringify dua kali
                    schema: schema ? JSON.stringify(schema) : undefined,
                    // Proxy server akan menentukan apakah akan menggunakan Google Search grounding berdasarkan keberadaan 'schema'
                };
                
                const apiUrl = RENDER_AI_PROXY_URL; // Target: Server Render Anda

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(clientPayload) 
                        });
                        
                        if (!response.ok) { 
                            const errorText = await response.text(); 
                            throw new Error(`Proxy Server Error (${response.status}): ${errorText}`); 
                        }
                        
                        // Asumsi: Proxy Server Anda mengembalikan hasil akhir dalam format { text: "..." }
                        const result = await response.json();
                        const textData = result.text; // Ambil konten dari kunci 'text'

                        if (textData) {
                            if (schema) {
                                try { 
                                    // Jika ada skema, data adalah JSON string, maka harus diparse
                                    return JSON.parse(textData); 
                                } 
                                catch (e) { 
                                    console.error("Gagal mem-parsing JSON dari Proxy:", textData, e); 
                                    throw new Error("Gagal parsing JSON"); 
                                }
                            }
                            return textData; // Mengembalikan teks biasa jika tidak ada skema
                        }
                    } catch (error) { 
                        console.error(`Percobaan ${i + 1} gagal (via Proxy):`, error.message); 
                    }
                    if (i < retries - 1) await new Promise(res => setTimeout(res, delay * (i + 1)));
                }
                return null;
            }

            // MODIFIED: Menggunakan currentMarketMode untuk inisialisasi analisis
            async function handleFetchData(ticker, price = null) {
                currentAnalysisTicker = ticker;
                switchTab('analysis');
                document.querySelector('#analysis-tab-content .sub-tab-btn[data-target="direct-analysis-sub-content"]').click();
                
                const isCrypto = currentMarketMode === 'crypto';
                
                // Update UI Analisis (hilangkan Checklist untuk Kripto, karena metrik berbeda)
                investorChecklistSection.classList.toggle('hidden', isCrypto);
                
                analysisPlaceholder.classList.add('hidden');
                analysisResultsContainer.classList.remove('hidden');
                stockName.textContent = `Analisis untuk ${ticker}`;
                projectionContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
                companyProfileContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
                fundamentalDataContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
                advancedOutputContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Lengkapi checklist di atas dan klik tombol di bawah untuk mendapatkan analisis mendalam dari AI.</p>`;
                debateResultsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Dapatkan dua sisi argumen dari AI untuk membuat keputusan yang lebih matang.</p>`;
                runAdvancedAnalysisButton.disabled = false;
                
                if (!isCrypto) {
                    loadChecklistForAnalysis();
                }

                displayTradingViewWidget(ticker, 'technical-chart-container');
                const backendData = await triggerBackendFetch(ticker);
                const finalPrice = price !== null ? price : (backendData ? backendData.regularMarketPrice : null);

                // Panggil fungsi yang sesuai
                if (isCrypto) {
                    fetchCryptoMetrics(ticker, finalPrice);
                    fetchCompanyProfile(ticker, isCrypto); // Re-use profile, adjust prompt
                    fetchProjectionData(ticker, finalPrice, isCrypto); // Re-use projection, adjust prompt
                } else {
                    fetchFundamentalData(ticker, finalPrice);
                    fetchCompanyProfile(ticker);
                    fetchProjectionData(ticker, finalPrice);
                }
            }
            // END MODIFIED

            // MODIFIED: Menggunakan currentMarketMode untuk TradingView Widget
            function displayTradingViewWidget(ticker, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                const theme = htmlTag.classList.contains('dark') ? 'dark' : 'light';
                const isCrypto = currentMarketMode === 'crypto';
                
                let tradingViewSymbol;
                let tradingViewInterval = "D";
                
                if (isCrypto) {
                    tradingViewSymbol = `BINANCE:${ticker}USDT`; // Contoh: BTC-USD menjadi BINANCE:BTCUSDT
                    tradingViewInterval = "4H"; // Interval yang lebih pendek untuk Kripto
                } else {
                    tradingViewSymbol = `IDX:${ticker.replace('.JK', '')}`; // Contoh: BBCA.JK menjadi IDX:BBCA
                    tradingViewInterval = "D";
                }
                
                new TradingView.widget({ 
                    "width": "100%", 
                    "height": "100%", 
                    "symbol": tradingViewSymbol, 
                    "interval": tradingViewInterval, 
                    "timezone": "Asia/Jakarta", 
                    "theme": theme, 
                    "style": "1", 
                    "locale": "id", 
                    "toolbar_bg": "#f1f3f6", 
                    "enable_publishing": false, 
                    "allow_symbol_change": true, 
                    "container_id": containerId 
                });
            }
            // END MODIFIED

            // MODIFIED: Fungsi fetchFundamentalData diubah menjadi khusus saham
            async function fetchFundamentalData(ticker, price) {
                let prompt = price 
                    ? `Dengan informasi bahwa harga terakhir ${ticker} adalah sekitar Rp ${new Intl.NumberFormat('id-ID').format(price)}, berikan data fundamental utama: Market Cap, P/E Ratio (TTM), EPS (TTM), ROE, P/B Ratio, Dividend Yield. Gunakan riset terkini.`
                    : `Berikan data fundamental utama untuk ${ticker}: Market Cap, P/E Ratio (TTM), EPS (TTM), ROE, P/B Ratio, Dividend Yield. Gunakan riset terkini.`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        ticker: { type: "STRING" },
                        data_fundamental: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    key: { type: "STRING", description: "Kunci singkat: MCAP, PER, EPS, ROE, PBV, DY" },
                                    label: { type: "STRING", description: "Nama metrik yang panjang untuk tampilan UI (misalnya: P/E Ratio TTM)" },
                                    nilai: { type: "STRING", description: "Nilai metrik, termasuk satuan (misalnya: 15.2x, 0.8x, 50 T)" }
                                },
                                required: ["key", "label", "nilai"]
                            }
                        }
                    },
                    required: ["ticker", "data_fundamental"]
                };
                
                const data = await fetchFromGemini(prompt, schema);
                
                if (document.getElementById(`fundamental-data-container`)) {
                    displayFundamentalData(data?.data_fundamental || []);
                }
                return data?.data_fundamental || null;
            }
            // END MODIFIED
            
            // FUNGSI BARU: Untuk Metrik Kripto
            async function fetchCryptoMetrics(ticker, price) {
                let prompt = price 
                    ? `Untuk aset kripto ${ticker}, dengan harga saat ini sekitar $${new Intl.NumberFormat('id-ID').format(price)}, berikan metrik kunci: Market Cap, Circulating Supply, Total Value Locked (TVL), dan All-Time High. Gunakan riset terkini.`
                    : `Untuk aset kripto ${ticker}, berikan metrik kunci: Market Cap, Circulating Supply, Total Value Locked (TVL), dan All-Time High. Gunakan riset terkini.`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        ticker: { type: "STRING" },
                        data_fundamental: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    key: { type: "STRING", description: "Kunci singkat: MCAP, CSUPPLY, TVL, ATH" },
                                    label: { type: "STRING", description: "Nama metrik yang panjang untuk tampilan UI (misalnya: Total Value Locked)" },
                                    nilai: { type: "STRING", description: "Nilai metrik, termasuk satuan (misalnya: $50 B, 15 M)" }
                                },
                                required: ["key", "label", "nilai"]
                            }
                        }
                    },
                    required: ["ticker", "data_fundamental"]
                };
                
                const data = await fetchFromGemini(prompt, schema);
                
                if (document.getElementById(`fundamental-data-container`)) {
                    // Re-use display function
                    displayFundamentalData(data?.data_fundamental || []);
                }
                // Return data in the same shape as Saham for handleCompareStocks compatibility
                return data?.data_fundamental || null; 
            }
            // END FUNGSI BARU

            // MODIFIED: Menggunakan struktur data baru (data_fundamental)
            function displayFundamentalData(data) {
                if (!data || data.length === 0) { fundamentalDataContainer.innerHTML = `<p class="text-center text-sm">Data ${currentMarketMode === 'crypto' ? 'kripto' : 'fundamental'} tidak ditemukan.</p>`; return; }
                fundamentalDataContainer.innerHTML = '';
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm bg-gray-50 dark:bg-gray-800 p-2.5 rounded-lg';
                    // Menggunakan item.label untuk tampilan, item.key untuk internal (jika perlu)
                    div.innerHTML = `<span>${item.label}</span><span class="font-semibold">${item.nilai}</span>`;
                    fundamentalDataContainer.appendChild(div);
                });
            }
            // END MODIFIED
            
            // MODIFIED: Menambahkan parameter isCrypto ke fetchCompanyProfile
            async function fetchCompanyProfile(ticker, isCrypto = false) {
                let assetType = isCrypto ? 'aset kripto' : 'perusahaan';
                let prompt = `Berikan ringkasan profil singkat untuk ${assetType} ${ticker}. Format sebagai JSON: {"profil": "..."}`;
                const schema = { type: "OBJECT", properties: { "profil": { type: "STRING" } }, required: ["profil"] };
                const data = await fetchFromGemini(prompt, schema);
                displayCompanyProfile(data);
            }
            // END MODIFIED

            function displayCompanyProfile(data) {
                if (!data || !data.profil) { companyProfileContainer.innerHTML = `<p class="text-center text-sm">Profil tidak ditemukan.</p>`; return; }
                companyProfileContainer.innerHTML = `<p class="text-sm leading-relaxed">${data.profil}</p>`;
            }
            
            // MODIFIED: Menambahkan parameter isCrypto ke fetchProjectionData
            async function fetchProjectionData(ticker, price, isCrypto = false) {
                let assetType = isCrypto ? 'aset kripto' : 'saham';
                let currency = isCrypto ? '$' : 'Rp ';
                
                let prompt = price
                    ? `Berikan ringkasan proyeksi harga untuk ${assetType} ${ticker} dengan mempertimbangkan harga saat ini adalah ${currency}${new Intl.NumberFormat('id-ID').format(price)}. Sampaikan dalam 3-4 kalimat. Format sebagai JSON: {"analisis": "..."}`
                    : `Berikan ringkasan proyeksi harga untuk ${assetType} ${ticker} dalam 3-4 kalimat. Format sebagai JSON: {"analisis": "..."}`;
                const schema = { type: "OBJECT", properties: { "analisis": { type: "STRING" } }, required: ["analisis"] };
                const data = await fetchFromGemini(prompt, schema);
                displayProjectionData(data);
            }
            // END MODIFIED

            function displayProjectionData(data) {
                if (!data || !data.analisis) { projectionContainer.innerHTML = `<p class="text-center">Analisis tidak ditemukan.</p>`; return; }
                projectionContainer.innerHTML = `<p class="text-sm leading-relaxed">${data.analisis}</p>`;
            }
            
            // MODIFIED: Menyesuaikan Advanced Analysis untuk Kripto
            async function handleAdvancedAnalysisClick() {
                if (!currentAnalysisTicker) return;
                const isCrypto = currentMarketMode === 'crypto';
                
                runAdvancedAnalysisButton.disabled = true;
                advancedOutputContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;

                let checklistContext = "Analisis tidak menggunakan checklist (Mode Kripto).";
                if (!isCrypto) {
                    const checklistContainer = document.getElementById('checklist-container');
                    checklistContext = "Pengguna telah melakukan checklist dengan hasil sebagai berikut: ";
                    const checklistItems = checklistContainer.querySelectorAll('.checklist-item-container');
                    let hasCheckedItems = false;
                    checklistItems.forEach(item => {
                        const checkbox = item.querySelector('.checklist-item');
                        const question = item.querySelector('label').textContent;
                        const autoCheckResult = item.querySelector('.checklist-result').textContent;
                        if (checkbox.checked) {
                            hasCheckedItems = true;
                            checklistContext += `[V] ${question}. `;
                            if (autoCheckResult) {
                                checklistContext += `(Hasil Cek Otomatis: ${autoCheckResult}). `;
                            }
                        }
                    });
                    if (!hasCheckedItems) {
                        checklistContext = "Pengguna tidak mengisi checklist.";
                    }
                }
                
                const assetType = isCrypto ? 'aset kripto' : 'saham';
                const marketContext = isCrypto ? 'pasar kripto, dinamika tokenomics, dan sentimen adopsi' : 'pasar BEI, berita, dan data makroekonomi';

                const prompt = `Sebagai analis ahli, lakukan riset ${marketContext} terkini untuk ${assetType} ${currentAnalysisTicker}. Pertimbangkan: "${checklistContext}". Berikan dua skenario: 1. Untuk Pemegang Aset (Holder): rekomendasi (Beli Lagi/Tahan/Jual) dan ringkasan. 2. Untuk Calon Investor (Watcher): berikan rekomendasi harga beli dalam rentang angka spesifik (misal: "Rp 10.000 - Rp 10.500" atau "$50 - $55") dan kondisi terbaik untuk masuk. Sertakan juga poin positif (bullish) dan negatif (bearish). Format sebagai JSON: {holder: {rekomendasi, ringkasan}, watcher: {rekomendasi_harga_beli, kondisi_terbaik}, poin_positif: [], poin_negatif: []}.`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        holder: { type: "OBJECT", properties: { rekomendasi: { type: "STRING" }, ringkasan: { type: "STRING" } } },
                        watcher: { type: "OBJECT", properties: { rekomendasi_harga_beli: { type: "STRING" }, kondisi_terbaik: { type: "STRING" } } },
                        poin_positif: { type: "ARRAY", items: { type: "STRING" } },
                        poin_negatif: { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["holder", "watcher", "poin_positif", "poin_negatif"]
                };
                const data = await fetchFromGemini(prompt, schema);
                displayAdvancedAnalysis(data);
                runAdvancedAnalysisButton.disabled = false;
            }
            // END MODIFIED

            function displayAdvancedAnalysis(data) {
                if (!data || !data.holder || !data.watcher) {
                    advancedOutputContainer.innerHTML = `<p class="text-center">Analisis tidak tersedia.</p>`;
                    return;
                }

                const recommendation = data.holder.rekomendasi.toUpperCase();
                let colorClass, iconName;

                if (recommendation.includes('BELI')) { colorClass = 'text-green-500'; iconName = 'trending-up-outline'; } 
                else if (recommendation.includes('JUAL')) { colorClass = 'text-red-500'; iconName = 'trending-down-outline'; } 
                else { colorClass = 'text-yellow-500'; iconName = 'remove-outline'; }
                
                const assetTypeLabel = currentMarketMode === 'crypto' ? 'Pemegang Aset' : 'Pemegang Saham';

                let positivePointsHTML = data.poin_positif.map(point => `<li class="flex items-start gap-2"><ion-icon name="checkmark-circle-outline" class="text-green-500 text-xl flex-shrink-0"></ion-icon><span>${point}</span></li>`).join('');
                let negativePointsHTML = data.poin_negatif.map(point => `<li class="flex items-start gap-2"><ion-icon name="close-circle-outline" class="text-red-500 text-xl flex-shrink-0"></ion-icon><span>${point}</span></li>`).join('');

                advancedOutputContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><ion-icon name="person-circle-outline"></ion-icon>Untuk ${assetTypeLabel} (Holder)</h4>
                            <p class="text-3xl font-extrabold ${colorClass} flex items-center gap-2"><ion-icon name="${iconName}"></ion-icon>${data.holder.rekomendasi}</p>
                            <p class="mt-2 text-sm">${data.holder.ringkasan}</p>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-xl">
                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><ion-icon name="eye-outline"></ion-icon>Untuk Calon Investor (Watcher)</h4>
                            <p class="font-semibold">Rekomendasi Harga Beli: <span class="font-normal text-blue-500">${data.watcher.rekomendasi_harga_beli}</span></p>
                            <p class="mt-2 font-semibold">Kondisi Terbaik: <span class="font-normal">${data.watcher.kondisi_terbaik}</span></p>
                        </div>
                    </div>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                        <div>
                            <h5 class="font-bold mb-2 text-green-600 dark:text-green-400">Sinyal Positif (Bullish)</h5>
                            <ul class="space-y-2">${positivePointsHTML}</ul>
                        </div>
                        <div>
                            <h5 class="font-bold mb-2 text-red-600 dark:text-red-400">Sinyal Negatif (Bearish)</h5>
                            <ul class="space-y-2">${negativePointsHTML}</ul>
                        </div>
                    </div>
                    <div class="mt-8 text-center text-xs text-gray-500 dark:text-gray-400 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                        <p><span class="font-bold">⚠️ DYOR (Do Your Own Research).</span> Analisis ini adalah hasil olahan AI dan bukan merupakan nasihat keuangan. Selalu lakukan riset mandiri sebelum membuat keputusan investasi.</p>
                    </div>
                `;
            }
            
            function getCardHTML(stock, iconInfo, headerContent, badgeContent = '') {
                // MODIFIED: Menggunakan IDR atau USD berdasarkan mode
                const isCrypto = currentMarketMode === 'crypto';
                const currencySymbol = isCrypto ? '$' : 'Rp';

                return `
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center ${iconInfo.bgColor} ${iconInfo.textColor} rounded-full mt-1">
                            ${iconInfo.iconName ? `<ion-icon name="${iconInfo.iconName}" class="text-3xl"></ion-icon>` : headerContent}
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center">
                                <h4 class="text-lg font-bold">${stock.ticker}</h4>
                                <div class="flex items-center gap-2">
                                    ${iconInfo.iconName ? headerContent : ''}
                                    <button class="add-to-watchlist-btn text-gray-400 hover:text-yellow-500" data-ticker="${stock.ticker}" title="Tambah ke Watchlist">
                                        <ion-icon name="bookmark-outline" class="text-2xl"></ion-icon>
                                    </button>
                                </div>
                            </div>
                            <p class="text-md">${stock.nama_perusahaan}</p>
                            ${badgeContent}
                            <div class="mt-2 flex items-center gap-2">
                                <span class="font-semibold">${currencySymbol}</span>
                                <input type="number" id="price-input-${stock.ticker}" placeholder="Memuat..." class="price-input w-24 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-sm rounded-lg p-1.5 focus:ring-blue-500 focus:border-blue-500">
                                <button class="view-chart-btn text-blue-500 hover:text-blue-600" title="Lihat harga di sini" data-ticker="${stock.ticker}">
                                    <ion-icon name="analytics-outline" class="text-xl"></ion-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <p class="text-sm">${stock.alasan}</p>
                        <div id="backend-summary-${stock.ticker}" class="mt-3 text-xs text-gray-500 dark:text-gray-400 border-l-2 border-blue-500 pl-2 italic">
                            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-full animate-pulse"></div>
                            <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-5/6 mt-1 animate-pulse"></div>
                        </div>
                        <div class="mt-4 flex flex-wrap gap-2 items-center">
                            ${stock.bukti ? `<button class="show-details-btn bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold py-1.5 px-3 rounded-full text-xs" data-title="Bukti Multibagger: ${stock.ticker}" data-content="${stock.bukti}">Lihat Bukti</button>` : ''}
                            <button class="goto-analysis-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 rounded-full text-xs" data-ticker="${stock.ticker}">Analisis Lengkap</button>
                        </div>
                    </div>
                `;
            }

            async function fetchAndDisplayStocks(container, prompt, schema, getCardConfig) {
                container.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
                const stocksFromGemini = await fetchFromGemini(prompt, schema);
                
                if (!stocksFromGemini || stocksFromGemini.length === 0) {
                    container.innerHTML = `<p class="text-center">Tidak ditemukan aset yang cocok di mode ${currentMarketMode}.</p>`;
                    return;
                }
                
                container.innerHTML = ''; 

                stocksFromGemini.forEach(stock => {
                    const { iconInfo, headerContent, badgeContent } = getCardConfig(stock);
                    const item = document.createElement('div');
                    item.id = `stock-card-${stock.ticker}`;
                    item.className = 'card p-4';
                    item.innerHTML = getCardHTML(stock, iconInfo, headerContent, badgeContent);
                    container.appendChild(item);
                });
                
                updateWatchlistIcons();

                for (const stock of stocksFromGemini) {
                    const freshData = await triggerBackendFetch(stock.ticker);
                    const priceInput = document.getElementById(`price-input-${stock.ticker}`);
                    const backendSummaryEl = document.getElementById(`backend-summary-${stock.ticker}`);

                    if (freshData) {
                        if (priceInput) {
                            priceInput.placeholder = 'Harga...';
                            const priceNumber = parseFloat(String(freshData.regularMarketPrice).replace(/,/g, ''));
                            if (!isNaN(priceNumber)) {
                                priceInput.value = priceNumber;
                            }
                        }
                        if (backendSummaryEl) {
                            backendSummaryEl.innerHTML = freshData.aiAnalysis ? `<p>${freshData.aiAnalysis}</p>` : '';
                        }
                    } else {
                        if (priceInput) priceInput.placeholder = 'N/A';
                        if (backendSummaryEl) backendSummaryEl.innerHTML = `<p class="italic">Gagal mengambil data backend.</p>`;
                    }
                }
            }
            
            function getScreenerCardConfig(isMultibagger) {
                return function(stock) {
                    let iconInfo, headerContent = '';
                    if (isMultibagger) {
                        iconInfo = { bgColor: 'bg-gradient-to-br from-blue-400 to-indigo-500', textColor: 'text-white', iconName: 'rocket-outline' };
                    } else {
                        const rankColorBg = stock.peringkat <= 3 ? 'bg-green-100 dark:bg-green-900' : 'bg-yellow-100 dark:bg-yellow-900';
                        const rankColorText = stock.peringkat <= 3 ? 'text-green-800 dark:text-green-200' : 'text-yellow-800 dark:text-yellow-200';
                        headerContent = `<div class="w-10 h-10 flex items-center justify-center rounded-full font-bold text-xl">${stock.peringkat}</div>`;
                        iconInfo = { bgColor: rankColorBg, textColor: rankColorText, iconName: '' };
                    }
                    return { iconInfo, headerContent };
                }
            }

            function getDiscountHunterCardConfig() {
                return function(stock) {
                    const iconInfo = { bgColor: 'bg-cyan-100', textColor: 'text-cyan-600', iconName: 'pricetag-outline' };
                    const headerContent = `
                        <div class="flex items-center gap-1">
                            <div class="bg-red-100 text-red-800 text-sm font-bold px-3 py-1 rounded-full">${stock.penurunan_persen}</div>
                            <button class="discount-info-btn text-gray-400 hover:text-blue-500" data-info="${stock.dasar_penurunan || 'Dasar perhitungan tidak tersedia.'}">
                                <ion-icon name="information-circle-outline" class="text-lg"></ion-icon>
                            </button>
                        </div>`;
                    return { iconInfo, headerContent };
                }
            }

            function getBenchmarkCardConfig() {
                return function(stock) {
                    const iconInfo = { bgColor: 'bg-purple-100 dark:bg-purple-900', textColor: 'text-purple-800 dark:text-purple-200', iconName: 'star-outline' };
                    let badgeContent = '';
                    if (stock.tipe) {
                        const isPortfolio = stock.tipe === 'Portofolio Publik';
                        const badgeColor = isPortfolio
                            ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' 
                            : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                        const labelText = isPortfolio
                            ? 'Memiliki saham ini' 
                            : `Cocok dengan gaya ${selectedInvestor.name}`;
                        badgeContent = `<span class="mt-1 inline-block text-xs font-semibold px-2.5 py-0.5 rounded-full ${badgeColor}">${labelText}</span>`;
                    }
                    return { iconInfo, headerContent: '', badgeContent };
                }
            }

            // MODIFIED: Sesuaikan Screener untuk Kripto
            async function handleScreenerClick() {
                screenerButton.disabled = true; screenerButton.classList.add('opacity-50');
                const isMultibagger = multibaggerToggle.checked;
                const selectedSector = sectorSelect.value;
                const customPrompt = aiPromptInput.value.trim();
                
                const isCrypto = currentMarketMode === 'crypto';
                let assetLabel = isCrypto ? 'aset kripto' : 'saham di BEI';
                let marketContext = isCrypto ? 'dinamika pasar kripto global dan sentimen adopsi' : 'berita pasar terkini dan data ekonomi makro Indonesia (suku bunga BI, inflasi BPS, nilai tukar Rupiah)';
                
                let sectorQuery = (selectedSector !== "semua") ? ` dari sektor ${selectedSector}` : "";
                let customQuery = customPrompt ? ` Fokus pada ${assetLabel} yang cocok dengan kriteria berikut: "${customPrompt}".` : "";
                
                let prompt, schema;
                
                const baseInstruction = `Sebagai analis ${isCrypto ? 'kripto' : 'saham'} ahli, periksa ${marketContext}. Berdasarkan analisis tersebut, `;

                if (isMultibagger) {
                    // Multibagger untuk Kripto diganti dengan "High Growth Potential"
                    prompt = `${baseInstruction} cari 5 ${assetLabel} yang memiliki potensi pertumbuhan tinggi (sering disebut '10x potential'). Sertakan ticker, nama (atau nama koin), bukti teknikal/tokenomics, dan alasan singkat mengapa aset ini relevan dengan kondisi pasar saat ini. Format sebagai JSON array: ticker, nama_perusahaan, bukti, alasan.`;
                    schema = { type: "ARRAY", items: { type: "OBJECT", properties: { ticker: { type: "STRING" }, nama_perusahaan: { type: "STRING" }, bukti: { type: "STRING" }, alasan: { type: "STRING" } }, required: ["ticker", "nama_perusahaan", "bukti", "alasan"] } };
                } else {
                    const selectedRiskProfile = riskProfileSelect.value;
                    let riskProfileQuery = "";
                    if (selectedRiskProfile === "stabil") { riskProfileQuery = isCrypto ? " Fokus pada koin 'blue-chip' (Bitcoin/Ethereum) atau proyek De-Fi/L1 yang mapan." : " Fokus pada saham 'value' atau 'blue-chip'."; }
                    else if (selectedRiskProfile === "pertumbuhan") { riskProfileQuery = isCrypto ? " Fokus pada koin/token kapitalisasi kecil/menengah dengan katalis kuat." : " Fokus pada saham 'growth'."; }
                    
                    prompt = `${baseInstruction} berikan peringkat 5 besar ${assetLabel}${sectorQuery} dengan potensi terbaik.${riskProfileQuery}${customQuery} Sertakan: peringkat, ticker, nama perusahaan (atau nama koin), dan alasan singkat mengapa aset ini relevan dengan kondisi pasar saat ini. Format sebagai JSON array.`;
                    schema = { type: "ARRAY", items: { type: "OBJECT", properties: { peringkat: { type: "NUMBER" }, ticker: { type: "STRING" }, nama_perusahaan: { type: "STRING" }, alasan: { type: "STRING" } }, required: ["peringkat", "ticker", "nama_perusahaan", "alasan"] } };
                }
                
                try {
                    await fetchAndDisplayStocks(screenerResultsContainer, prompt, schema, getScreenerCardConfig(isMultibagger));
                } finally {
                    screenerButton.disabled = false; screenerButton.classList.remove('opacity-50');
                }
            }
            // END MODIFIED
            
            // MODIFIED: Sesuaikan Discount Hunter untuk Kripto
            async function handleDiscountHunterClick() {
                findDiscountButton.disabled = true; findDiscountButton.classList.add('opacity-50');
                const selectedSector = discountSectorSelect.value;
                const isCrypto = currentMarketMode === 'crypto';
                let assetLabel = isCrypto ? 'aset kripto' : 'saham berfundamental kuat di BEI';
                
                let sectorQuery = (selectedSector !== "semua") ? ` dari sektor ${selectedSector}` : "";
                
                const prompt = `Dengan mempertimbangkan berita pasar dan data ekonomi terkini, cari 5 ${assetLabel}${sectorQuery} yang harganya sedang terkoreksi. Sertakan persentase penurunan, alasan singkat, dan dasar perhitungan penurunan (contoh: 'dari harga tertinggi 3 bulan terakhir'). Format sebagai JSON array.`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { ticker: { type: "STRING" }, nama_perusahaan: { type: "STRING" }, penurunan_persen: { type: "STRING" }, alasan: { type: "STRING" }, dasar_penurunan: { type: "STRING" } }, required: ["ticker", "nama_perusahaan", "penurunan_persen", "alasan", "dasar_penurunan"] } };
                try {
                     await fetchAndDisplayStocks(discountHunterResultsContainer, prompt, schema, getDiscountHunterCardConfig());
                } finally {
                    findDiscountButton.disabled = false; findDiscountButton.classList.remove('opacity-50');
                }
            }
            // END MODIFIED
            
            // MODIFIED: Sembunyikan Benchmark (Gaya Investor) untuk Kripto (untuk saat ini)
            async function handleBenchmarkClick() {
                if (currentMarketMode === 'crypto') {
                    benchmarkResultsContainer.innerHTML = `<p class="text-center text-red-500">Fitur Gaya Investor saat ini hanya tersedia untuk pasar Saham (BEI).</p>`;
                    return;
                }
                
                if (!selectedInvestor) { benchmarkResultsContainer.innerHTML = `<p class="text-center">Pilih seorang investor.</p>`; return; }
                
                const philosophyHTML = `
                    <div class="card p-4 mb-6 bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800">
                        <h3 class="font-bold text-purple-800 dark:text-purple-200">${selectedInvestor.name}</h3>
                        <p class="text-sm text-purple-700 dark:text-purple-300 mt-1">${selectedInvestor.style}</p>
                    </div>
                `;
                benchmarkResultsContainer.innerHTML = philosophyHTML;

                const prompt = `Berdasarkan berita dan data pasar terkini, untuk investor ${selectedInvestor.name} (${selectedInvestor.style}), berikan dua daftar: 1. Saham di BEI yang sesuai dengan gaya investasinya saat ini. 2. Saham di BEI yang diketahui publik ada di portofolionya. Untuk setiap saham, berikan ticker, nama_perusahaan, alasan singkat, dan tipe ('Gaya Investasi' atau 'Portofolio Publik'). Gabungkan kedua daftar dan berikan maksimal 5 saham total. Format sebagai JSON array.`;
                const schema = { type: "ARRAY", items: { type: "OBJECT", properties: { ticker: { type: "STRING" }, nama_perusahaan: { type: "STRING" }, alasan: { type: "STRING" }, tipe: { type: "STRING" } }, required: ["ticker", "nama_perusahaan", "alasan", "tipe"] } };
                
                const loadingContainer = document.createElement('div');
                loadingContainer.innerHTML = `<div class="flex justify-center p-4"><div class="loader"></div></div>`;
                benchmarkResultsContainer.appendChild(loadingContainer);

                const stocks = await fetchFromGemini(prompt, schema);
                loadingContainer.remove();

                if (!stocks || stocks.length === 0) {
                    benchmarkResultsContainer.innerHTML += `<p class="text-center">Tidak ditemukan saham yang cocok.</p>`;
                    return;
                }
                
                for (const stock of stocks) {
                    const { iconInfo, headerContent, badgeContent } = getBenchmarkCardConfig()(stock);
                    const item = document.createElement('div');
                    item.className = 'card p-4 mb-4';
                    item.innerHTML = getCardHTML(stock, iconInfo, headerContent, badgeContent);
                    benchmarkResultsContainer.appendChild(item);
                }
                
                updateWatchlistIcons();

                for (const stock of stocks) {
                    const freshData = await triggerBackendFetch(stock.ticker);
                    const priceInput = document.getElementById(`price-input-${stock.ticker}`);
                    const backendSummaryEl = document.getElementById(`backend-summary-${stock.ticker}`);

                    if (freshData) {
                        if (priceInput) {
                            priceInput.placeholder = 'Harga...';
                            priceInput.value = parseFloat(String(freshData.regularMarketPrice).replace(/,/g, '')) || '';
                        }
                        if (backendSummaryEl) backendSummaryEl.innerHTML = freshData.aiAnalysis ? `<p>${freshData.aiAnalysis}</p>` : '';
                    } else {
                        if (priceInput) priceInput.placeholder = 'N/A';
                        if (backendSummaryEl) backendSummaryEl.innerHTML = `<p class="italic">Gagal mengambil data backend.</p>`;
                    }
                }
            }
            // END MODIFIED

            async function handleIpoAnalysisClick(companyName) {
            // MODIFIKASI: Gunakan fetchedIpoList dan companyName
            if (currentMarketMode === 'crypto') return; // Pastikan hanya untuk saham
            
            const ipoInfo = fetchedIpoList.find(ipo => ipo.companyName === companyName);
            if (!ipoInfo) return;

            const modalContent = `<div id="ipo-modal-content" class="flex justify-center p-8"><div class="loader"></div></div>`;
                showModal(`Analisis IPO: ${companyName}`, modalContent);

                let priceInfo = '';
                let priceContextForPrompt = '';

            // MODIFIKASI: Gunakan offeringPeriod dan offeringPrice dari Firebase
            if (ipoInfo.offeringPeriod.toLowerCase().includes('sudah listing')) { // Asumsi status ada di dalam string 'period'
                const backendData = await triggerBackendFetch(ipoInfo.ticker);
                if (backendData && backendData.regularMarketPrice) {
                        const formattedPrice = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(backendData.regularMarketPrice);
                        priceInfo = `<div class="mb-4"><h4 class="font-bold text-lg">Harga Saat Ini</h4><p class="text-2xl font-bold text-green-600 dark:text-green-400">${formattedPrice}</p></div>`;
                        priceContextForPrompt = `Harga saham saat ini adalah ${formattedPrice}.`;
                    } else {
                        priceInfo = `<div class="mb-4"><h4 class="font-bold text-lg">Harga Saat Ini</h4><p>Gagal memuat harga.</p></div>`;
                        priceContextForPrompt = 'Harga saat ini tidak dapat dimuat.';
                    }
            } else {
                priceInfo = `<div class="mb-4"><h4 class="font-bold text-lg">Perkiraan Harga</h4><p class="text-xl font-bold text-blue-600 dark:text-blue-400">${ipoInfo.offeringPrice}</p></div>`;
                priceContextForPrompt = `Perusahaan ini akan IPO dengan ${ipoInfo.offeringPrice}.`;
            }
            // AKHIR MODIFIKASI

            const prompt = `Lakukan riset berita terkini tentang perusahaan "${companyName}". Berikan analisis singkat untuk IPO perusahaan ini. ${priceContextForPrompt} Fokus pada: 1. Prospek bisnis perusahaan. 2. Penggunaan dana IPO. 3. Poin positif (kekuatan). 4. Poin negatif (risiko). Jawab dalam format JSON dengan kunci: prospek, penggunaan_dana, poin_positif (array), poin_negatif (array).`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        prospek: { type: "STRING" },
                        penggunaan_dana: { type: "STRING" },
                        poin_positif: { type: "ARRAY", items: { type: "STRING" } },
                        poin_negatif: { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["prospek", "penggunaan_dana", "poin_positif", "poin_negatif"]
                };

                const data = await fetchFromGemini(prompt, schema);
                const modalContentEl = document.getElementById('ipo-modal-content');

                if (data && modalContentEl) {
                    let positivePointsHTML = data.poin_positif.map(point => `<li class="flex items-start gap-2"><ion-icon name="checkmark-circle-outline" class="text-green-500 text-xl flex-shrink-0"></ion-icon><span>${point}</span></li>`).join('');
                    let negativePointsHTML = data.poin_negatif.map(point => `<li class="flex items-start gap-2"><ion-icon name="close-circle-outline" class="text-red-500 text-xl flex-shrink-0"></ion-icon><span>${point}</span></li>`).join('');

                    modalContentEl.innerHTML = `
                        <div class="space-y-4 text-sm">
                            ${priceInfo}
                            <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="font-bold text-lg mb-1">Prospek Bisnis</h4>
                                <p>${data.prospek}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-1">Penggunaan Dana IPO</h4>
                                <p>${data.penggunaan_dana}</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <h5 class="font-bold mb-2 text-green-600 dark:text-green-400">Poin Positif</h5>
                                    <ul class="space-y-2">${positivePointsHTML}</ul>
                                </div>
                                <div>
                                    <h5 class="font-bold mb-2 text-red-600 dark:text-red-400">Risiko & Peringatan</h5>
                                    <ul class="space-y-2">${negativePointsHTML}</ul>
                                </div>
                            </div>
                             <div class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                                <p><span class="font-bold">⚠️ DYOR (Do Your Own Research).</span> Analisis ini adalah hasil olahan AI dan bukan merupakan nasihat keuangan. Selalu lakukan riset mandiri sebelum membuat keputusan investasi.</p>
                            </div>
                        </div>
                    `;
                } else if (modalContentEl) {
                    modalContentEl.innerHTML = '<p class="text-center">Gagal memuat analisis. Silakan coba lagi.</p>';
                }
            }

            document.body.addEventListener('click', function(event) {
                const target = event.target;
                const button = target.closest('button');
                if (!button) return;

                if (button.classList.contains('goto-analysis-btn')) {
                    const ticker = button.dataset.ticker;
                    const priceInput = document.getElementById(`price-input-${ticker}`);
                    const price = priceInput ? parseFloat(priceInput.value) : null;
                    if (ticker) handleFetchData(ticker, price);
                } else if (button.classList.contains('show-details-btn')) {
                    const title = button.dataset.title;
                    const content = button.dataset.content;
                    showModal(title, content);
                } else if (button.classList.contains('view-chart-btn')) {
                    const ticker = button.dataset.ticker;
                    if (ticker) showChartModal(ticker);
                } else if (button.classList.contains('ipo-analysis-btn')) {
                    const companyName = button.dataset.company;
                    handleIpoAnalysisClick(companyName);
                } else if (button.classList.contains('discount-info-btn')) {
                    const info = button.dataset.info;
                    showModal('Dasar Perhitungan Diskon', `<p>${info}</p>`);
                } else if (button.classList.contains('add-to-watchlist-btn')) {
                    const ticker = button.dataset.ticker;
                    toggleWatchlist(ticker);
                } else if (button.classList.contains('save-portfolio-btn')) {
                    const portfolioData = JSON.parse(button.dataset.portfolio);
                    const portfolioName = button.dataset.name || `Portofolio AI ${new Date().toLocaleDateString()}`;
                    const capital = parseFloat(button.dataset.capital); // GET CAPITAL FOR AI GENERATED PORTFOLIO
                    savePortfolio(portfolioName, portfolioData, capital); // PASS CAPITAL
                } else if (button.classList.contains('delete-portfolio-btn')) {
                    const portfolioId = button.dataset.id;
                    deletePortfolio(portfolioId);
                } else if (button.classList.contains('health-check-btn')) {
                    const portfolioData = JSON.parse(button.dataset.portfolio);
                    handlePortfolioHealthCheck(portfolioData);
                }
            });
            
            async function handleAutoCheck(questionKey, button) {
                if (!currentAnalysisTicker) {
                    showModal('Peringatan', 'Pilih saham di tab Analisis terlebih dahulu untuk menggunakan fitur ini.');
                    return;
                }
                const resultSpan = button.nextElementSibling;
                resultSpan.innerHTML = `<div class="mini-loader"></div></div>`;
                
                const prompt = `Untuk saham ${currentAnalysisTicker}, jawab pertanyaan ini: "${questionKey}" Berikan jawaban 'Ya', 'Tidak', atau 'Netral' dan alasan singkat dalam satu kalimat. Format sebagai JSON: {jawaban: "...", alasan: "..."}`;
                const schema = { type: "OBJECT", properties: { jawaban: { type: "STRING" }, alasan: { type: "STRING" } }, required: ["jawaban", "alasan"] };
                const result = await fetchFromGemini(prompt, schema);

                if (result) {
                    let colorClass = 'text-gray-500';
                    if (result.jawaban.toLowerCase() === 'ya') colorClass = 'text-green-600 dark:text-green-400';
                    if (result.jawaban.toLowerCase() === 'tidak') colorClass = 'text-red-600 dark:text-red-400';
                    resultSpan.innerHTML = `<strong class="${colorClass}">${result.jawaban}.</strong> ${result.alasan}`;
                } else {
                    resultSpan.innerHTML = 'Gagal memuat data.';
                }
            }
            
            function updateChecklistScore() {
                const checklistContainer = document.getElementById('checklist-container');
                if (!checklistContainer) return;

                const checklistItems = [
                    { weight: 20 }, { weight: 15 }, { weight: 15 }, { weight: 15 },
                    { weight: 10 }, { weight: 10 }, { weight: 10 }, { weight: 5 }
                ];

                let totalScore = 0;
                const checkboxes = checklistContainer.querySelectorAll('.checklist-item:checked');
                
                checkboxes.forEach(box => {
                    const parentContainer = box.closest('.checklist-item-container');
                    const index = Array.from(checklistContainer.children).indexOf(parentContainer);
                    if (index > -1) {
                        totalScore += checklistItems[index].weight;
                    }
                });

                const progressBar = document.getElementById('checklist-progress');
                const scoreEl = document.getElementById('checklist-score');
                const recommendationEl = document.getElementById('checklist-recommendation');
                
                if (progressBar && scoreEl && recommendationEl) {
                    const percentage = totalScore;
                    progressBar.style.width = `${percentage}%`;
                    scoreEl.textContent = `${totalScore}/100`;

                    if (percentage >= 80) {
                        recommendationEl.textContent = "Sangat Layak Dipertimbangkan";
                        progressBar.className = 'bg-green-500 h-4 rounded-full transition-all duration-300';
                    } else if (percentage >= 50) {
                        recommendationEl.textContent = "Layak Dianalisis Lebih Lanjut";
                        progressBar.className = 'bg-yellow-500 h-4 rounded-full transition-all duration-300';
                    } else {
                        recommendationEl.textContent = "Perlu Pertimbangan Ekstra";
                        progressBar.className = 'bg-red-500 h-4 rounded-full transition-all duration-300';
                    }
                }
            }

            function loadChecklistForAnalysis() {
                // ... (Checklist items tetap sama untuk Saham)
                const checklistItems = [
                    { key: 'Apakah saya memahami bisnis perusahaan ini?', info: 'Jelaskan dengan kata-kata sendiri apa yang perusahaan lakukan untuk menghasilkan uang. Jika tidak bisa, mungkin lebih baik dihindari.', weight: 20 },
                    { key: 'Apakah perusahaan ini mencetak laba secara konsisten (minimal 3 tahun terakhir)?', info: 'Cari data "Laba Bersih" atau "Net Income" di laporan keuangan tahunan.', weight: 15 },
                    { key: 'Apakah utang perusahaan ini wajar (DER di bawah 1x)?', info: 'Cari rasio "Debt to Equity Ratio" (DER). Angka di bawah 1 umumnya dianggap sehat.', weight: 15 },
                    { key: 'Apakah perusahaan memiliki keunggulan kompetitif (Moat)?', info: 'Pikirkan: Apakah produknya sulit ditiru? Apakah mereknya sangat kuat?', weight: 15 },
                    { key: 'Apakah manajemen perusahaan memiliki rekam jejak yang baik dan terpercaya?', info: 'Cari berita tentang CEO dan jajaran direksi. Apakah ada skandal?', weight: 10 },
                    { key: 'Apakah valuasi saham ini masuk akal (tidak terlalu mahal)?', info: 'Bandingkan rasio P/E dan P/BV dengan rata-rata industrinya.', weight: 10 },
                    { key: 'Apakah arus kas operasi perusahaan positif dan bertumbuh?', info: 'Cari "Operating Cash Flow" di laporan keuangan. Angka positif menunjukkan perusahaan menghasilkan uang tunai dari bisnis utamanya.', weight: 10 },
                    { key: 'Apakah saya siap jika harga saham ini turun 20%?', info: 'Ini adalah tes mental. Investasi selalu berisiko.', weight: 5 }
                ];

                const contentHTML = `
                    <h3 class="text-xl font-bold mb-4">Checklist Investor Cerdas</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Gunakan daftar periksa interaktif ini untuk menguji kelayakan saham ${currentAnalysisTicker}.</p>
                    <div id="checklist-container" class="space-y-4 text-left">
                        ${checklistItems.map(item => `
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg checklist-item-container">
                            <div class="flex items-start">
                                <input type="checkbox" class="checklist-item h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1">
                                <div class="ml-3 flex-grow">
                                    <label class="block font-medium">${item.key} <span class="text-xs font-normal text-gray-400">(${item.weight} poin)</span></label>
                                    <div class="flex items-center gap-3 mt-2">
                                        <button class="checklist-info-btn text-blue-500 hover:text-blue-600 text-sm flex items-center gap-1" data-info="${item.info}"><ion-icon name="information-circle-outline"></ion-icon> Info</button>
                                        <button class="checklist-auto-check-btn text-green-500 hover:text-green-600 text-sm flex items-center gap-1" data-key="${item.key}"><ion-icon name="sparkles-outline"></ion-icon> Cek Otomatis</button>
                                        <span class="checklist-result text-xs text-gray-500 dark:text-gray-400 flex-grow"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <h4 class="font-bold text-center">Skor Kelayakan Investasi</h4>
                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 mt-2">
                            <div id="checklist-progress" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="checklist-score" class="text-center font-bold text-2xl mt-2">0/100</p>
                        <p id="checklist-recommendation" class="text-center text-sm text-gray-500 dark:text-gray-400"></p>
                    </div>
                `;
                investorChecklistSection.innerHTML = contentHTML;

                document.querySelectorAll('.checklist-info-btn').forEach(btn => {
                    btn.addEventListener('click', () => showModal('Panduan Checklist', `<p>${btn.dataset.info}</p>`));
                });
                document.querySelectorAll('.checklist-auto-check-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleAutoCheck(btn.dataset.key, btn));
                });
                document.getElementById('checklist-container').addEventListener('change', updateChecklistScore);
            }
            
            // MODIFIED: Sesuaikan Strategy Generation untuk Kripto (tidak ada LOT)
            async function handleStrategyGeneration() {
                const capitalInput = document.getElementById('virtual-capital');
                const capital = capitalInput.value.replace(/\./g, '');
                const profitTarget = document.getElementById('profit-target').value;
                const riskTolerance = document.getElementById('risk-tolerance').value;
                const durationValue = document.getElementById('investment-duration-value').value;
                const durationUnit = document.getElementById('investment-duration-unit').value;
                const duration = `${durationValue} ${durationUnit}`;
                const focus = document.getElementById('focus-sector').value.trim();
                
                const isCrypto = currentMarketMode === 'crypto';
                const assetLabel = isCrypto ? 'aset kripto' : 'saham BEI';

                if (!capital || !profitTarget || !riskTolerance || !durationValue) {
                    showModal("Input Tidak Lengkap", "Mohon isi semua kolom yang wajib diisi.");
                    return;
                }

                strategyResultsContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                
                let focusQuery = focus ? `Fokus pada sektor/tema/niche berikut: "${focus}".` : "";

                const prompt = `Sebagai seorang manajer investasi ahli, lakukan riset pasar terkini. Buatkan alokasi portofolio virtual untuk investor di Indonesia.
                - Tipe Aset: ${assetLabel}
                - Modal: Rp ${capital}
                - Target Keuntungan: ${profitTarget}%
                - Durasi Investasi: ${duration}
                - Toleransi Risiko Maksimal: ${riskTolerance}%.
                - ${focusQuery}
                Berikan 4-5 ${assetLabel} untuk portofolio ini. Hasil harus dalam format JSON dengan kunci "portfolio" yang berisi array objek. Setiap objek harus memiliki kunci: "ticker", "nama_perusahaan" (atau nama koin), "alokasi_persen", dan "alasan". Pastikan total alokasi_persen adalah 100.`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        portfolio: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    ticker: { type: "STRING" },
                                    nama_perusahaan: { type: "STRING" },
                                    alokasi_persen: { type: "NUMBER" },
                                    alasan: { type: "STRING" }
                                },
                                required: ["ticker", "nama_perusahaan", "alokasi_persen", "alasan"]
                            }
                        }
                    },
                    required: ["portfolio"]
                };

                const data = await fetchFromGemini(prompt, schema);
                displayStrategyResults(data, capital);
            }
            // END MODIFIED

            function displayStrategyResults(data, capital) {
                if (!data || !data.portfolio || data.portfolio.length === 0) {
                    strategyResultsContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Gagal membuat strategi. Coba lagi.</p>`;
                    return;
                }
                
                const portfolioData = data.portfolio.map(stock => ({
                    ticker: stock.ticker,
                    allocation: stock.alokasi_persen
                }));
                
                const isCrypto = currentMarketMode === 'crypto';
                const currency = isCrypto ? '$' : 'Rp';

                let resultsHTML = `<h3 class="text-xl font-bold text-center mb-6">Rekomendasi Alokasi Portofolio</h3><div class="space-y-4">`;
                
                data.portfolio.forEach(stock => {
                    const amount = (stock.alokasi_persen / 100) * capital;
                    const formattedAmount = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);

                    resultsHTML += `
                        <div class="card p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-lg font-bold">${stock.ticker} - ${stock.nama_perusahaan}</h4>
                                    <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">${currency} ${new Intl.NumberFormat('id-ID').format(amount)} (${stock.alokasi_persen}%)</p>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
                                <p class="text-sm text-gray-600 dark:text-gray-400">${stock.alasan}</p>
                            </div>
                        </div>
                    `;
                });

                resultsHTML += `</div>
                <div class="mt-6 text-center">
                    <button class="save-portfolio-btn bg-gradient-to-r from-green-500 to-teal-600 hover:opacity-90 text-white font-bold py-3 px-8 rounded-full transition-opacity duration-300 text-lg"
                        data-portfolio='${JSON.stringify(portfolioData)}'
                        data-name="Portofolio Rekomendasi AI"
                        data-capital="${capital}">
                        <ion-icon name="save-outline" class="mr-2"></ion-icon>Simpan & Lacak Portofolio
                    </button>
                </div>`;
                strategyResultsContainer.innerHTML = resultsHTML;
            }
            
            function addManualPortfolioRow() {
                const newRow = document.createElement('div');
                newRow.className = 'flex items-center gap-2';
                newRow.innerHTML = `
                    <input type="text" class="portfolio-ticker strategy-input uppercase bg-gray-100 border border-gray-300 text-sm rounded-lg block w-full p-2.5" placeholder="Ticker Saham">
                    <input type="number" class="portfolio-allocation strategy-input bg-gray-100 border border-gray-300 text-sm rounded-lg block w-32 p-2.5" placeholder="Alokasi %">
                    <button class="remove-row-btn text-red-500 hover:text-red-700 p-2"><ion-icon name="trash-outline" class="text-xl"></ion-icon></button>
                `;
                manualPortfolioInputRows.appendChild(newRow);
            }

            // MODIFIED: Tambahkan logika visual loading saat menyimpan portofolio manual
            async function handleSaveManualPortfolio() {
                const portfolioName = document.getElementById('manual-portfolio-name').value.trim() || `Portofolio Manual ${new Date().toLocaleDateString()}`;
                const capitalInput = document.getElementById('manual-virtual-capital'); 
                const capital = capitalInput.value.replace(/\./g, ''); 
                
                const rows = manualPortfolioInputRows.querySelectorAll('.flex');
                let portfolio = [];
                let totalAllocation = 0;
                let isValid = true;
                const isCrypto = currentMarketMode === 'crypto';

                rows.forEach(row => {
                    const tickerInput = row.querySelector('.portfolio-ticker');
                    const allocationInput = row.querySelector('.portfolio-allocation');
                    const ticker = tickerInput.value.trim().toUpperCase();
                    const allocation = parseFloat(allocationInput.value);

                    if (ticker && !isNaN(allocation) && allocation > 0) {
                        portfolio.push({ ticker, allocation });
                        totalAllocation += allocation;
                    } else if (ticker || allocationInput.value.trim()) {
                        isValid = false; 
                    }
                });

                if (!isValid || portfolio.length === 0) {
                    showModal("Input Tidak Valid", "Pastikan semua baris terisi dengan ticker dan alokasi yang benar.");
                    return;
                }

                if (!capital || isNaN(parseFloat(capital)) || parseFloat(capital) <= 0) {
                    showModal("Input Tidak Valid", "Mohon masukkan Modal Virtual yang valid.");
                    return;
                }
                const totalCapital = parseFloat(capital);

                if (Math.round(totalAllocation) !== 100) {
                    showModal("Alokasi Tidak Valid", `Total alokasi harus 100%, saat ini totalnya ${totalAllocation}%.`);
                    return;
                }
                
                // START: LOGIKA LOADING
                saveManualPortfolioBtn.disabled = true;
                saveManualPortfolioBtn.innerHTML = '<div class="mini-loader mr-2"></div> Memproses...';
                // END: LOGIKA LOADING

                try {
                    await savePortfolio(portfolioName, portfolio, totalCapital, isCrypto); // Pass isCrypto
                } catch (error) {
                    console.error("Gagal menyimpan portofolio manual:", error);
                    showModal("Error", "Gagal menyimpan portofolio. Coba lagi.");
                } finally {
                    // KEMBALIKAN KE STATE AWAL
                    saveManualPortfolioBtn.disabled = false;
                    saveManualPortfolioBtn.innerHTML = '<ion-icon name="save-outline" class="mr-2"></ion-icon>Simpan & Lacak';
                }
            }
            // END MODIFIED

            // MODIFIED: Mengubah logika penyimpanan portofolio (menambahkan isCrypto)
            async function savePortfolio(name, stocks, totalCapital, isCrypto = false) {
                const portfolioRef = ref(database, `users/${userId}/${isCrypto ? 'crypto_portfolios' : 'portfolios'}`); // NEW PATH
                const sharesPerLot = 100;
                
                const holdings = {};
                
                let calculatedInitialInvestment = 0; 

                for (const stock of stocks) {
                    const backendData = await triggerBackendFetch(stock.ticker);
                    const initialPrice = backendData ? backendData.regularMarketPrice : 0;
                    
                    if (initialPrice === 0) {
                        showModal("Error Data Harga", `Gagal mendapatkan harga terbaru (Rp 0) untuk ${stock.ticker}. Portofolio tidak disimpan.`);
                        throw new Error(`Harga ${stock.ticker} adalah 0.`);
                    }

                    const moneyAllocated = totalCapital * (stock.allocation / 100);
                    let sharesBought;
                    let initialInvestment;

                    if (!isCrypto) {
                         // Logic Saham (Perhitungan Lot)
                        const lotsBought = Math.floor(moneyAllocated / (initialPrice * sharesPerLot));
                        sharesBought = lotsBought * sharesPerLot;
                        initialInvestment = sharesBought * initialPrice;
                    } else {
                        // Logic Kripto (Tidak ada Lot)
                        sharesBought = moneyAllocated / initialPrice; // Beli berdasarkan uang yang dialokasikan
                        initialInvestment = moneyAllocated; // Investasi riil sama dengan yang dialokasikan
                    }
                    
                    calculatedInitialInvestment += initialInvestment; // Akumulasi investasi riil

                    holdings[stock.ticker] = {
                        allocation: stock.allocation,
                        initialPrice: initialPrice,
                        companyName: backendData ? backendData.companyName : stock.ticker,
                        // NEW: Simpan data riil yang tidak akan berubah
                        sharesBought: sharesBought,
                        initialInvestment: initialInvestment,
                        isCrypto: isCrypto // Flag untuk melacak jenis aset
                    };
                }

                const newPortfolio = {
                    name: name,
                    createdAt: new Date().toISOString(),
                    totalCapital: totalCapital, 
                    calculatedInitialInvestment: calculatedInitialInvestment, 
                    holdings: holdings,
                    isCrypto: isCrypto // NEW: Simpan mode portofolio
                };

                try {
                    await push(portfolioRef, newPortfolio);
                    showModal("Sukses", `Portofolio "${name}" berhasil disimpan. Anda dapat melihatnya di tab Lacak.`);
                    switchTab('track');
                } catch (error) {
                    console.error("Gagal menyimpan portofolio:", error);
                    showModal("Error", "Gagal menyimpan portofolio ke database.");
                    throw error;
                }
            }
            // END MODIFIED

            // MODIFIED: Memuat portofolio berdasarkan mode saat ini
            async function loadAndDisplayPortfolios() {
                const isCrypto = currentMarketMode === 'crypto';
                const portfoliosRef = ref(database, `users/${userId}/${isCrypto ? 'crypto_portfolios' : 'portfolios'}`);
                
                portfoliosContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                healthCheckResultsContainer.innerHTML = '';
                
                try {
                    const snapshot = await get(portfoliosRef);
                    if (!snapshot.exists()) {
                        portfoliosContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-16">
                            <ion-icon name="briefcase-outline" class="text-6xl mx-auto"></ion-icon>
                            <p class="text-lg mt-4">Anda belum punya portofolio virtual di mode ${isCrypto ? 'Kripto' : 'Saham'}.</p>
                            <p class="text-sm">Buat portofolio di menu Lab untuk mulai melacaknya di sini.</p>
                        </div>`;
                        return;
                    }

                    const portfolios = snapshot.val();
                    portfoliosContainer.innerHTML = '';
                    for (const id in portfolios) {
                         // Hanya tampilkan portofolio yang sesuai dengan mode saat ini
                         if (!!portfolios[id].isCrypto === isCrypto) {
                             await displayPortfolioCard(id, portfolios[id]);
                         }
                    }
                    if (portfoliosContainer.children.length === 0) {
                         portfoliosContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-16">
                            <ion-icon name="briefcase-outline" class="text-6xl mx-auto"></ion-icon>
                            <p class="text-lg mt-4">Anda belum punya portofolio virtual di mode ${isCrypto ? 'Kripto' : 'Saham'}.</p>
                            <p class="text-sm">Buat portofolio di menu Lab untuk mulai melacaknya di sini.</p>
                        </div>`;
                    }
                } catch (error) {
                    console.error("Gagal memuat portofolio:", error);
                    portfoliosContainer.innerHTML = `<p class="text-center text-red-500">Gagal memuat portofolio.</p>`;
                }
            }
            // END MODIFIED
            
            // MODIFIED: Menyesuaikan tampilan Portfolio Card untuk Kripto/Saham
            async function displayPortfolioCard(id, portfolio) {
                const card = document.createElement('div');
                card.className = 'card p-6';
                card.id = `portfolio-${id}`;
                
                const isCrypto = portfolio.isCrypto || false; // Ambil flag dari data
                const currency = isCrypto ? '$' : 'Rp';
                const sharesLabel = isCrypto ? 'Unit' : 'Lembar';
                
                const formattedProvidedCapital = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: isCrypto ? 2 : 0 }).format(portfolio.totalCapital || 0);
                const formattedInitialInvestment = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: isCrypto ? 2 : 0 }).format(portfolio.calculatedInitialInvestment || 0);

                const difference = (portfolio.totalCapital || 0) - (portfolio.calculatedInitialInvestment || 0);
                const formattedDifference = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: isCrypto ? 2 : 0 }).format(difference);

                card.innerHTML = `<div class="flex justify-between items-center mb-4">
                                      <div>
                                        <h3 class="text-xl font-bold">${portfolio.name} <span class="text-xs text-gray-400">(${isCrypto ? 'KRIPTO' : 'SAHAM'})</span></h3>
                                        <p class="text-xs text-gray-500">Dibuat pada: ${new Date(portfolio.createdAt).toLocaleDateString()}</p>
                                        <div class="mt-2 text-sm">
                                            <p class="text-gray-600 dark:text-gray-400">Modal Disediakan: <span class="font-semibold">${formattedProvidedCapital}</span></p>
                                            <p id="total-initial-value-${id}" class="font-semibold text-gray-800 dark:text-gray-200 mt-1">Modal Awal Riil: <span class="mini-loader"></span></p>
                                            <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">Sisa Modal Virtual: ${formattedDifference}</p>
                                        </div>
                                      </div>
                                      <div class="text-right">
                                        <p class="text-sm">Total Nilai Saat Ini</p>
                                        <p id="total-value-${id}" class="text-2xl font-bold"><span class="mini-loader"></span></p>
                                        <p id="total-pl-${id}" class="text-sm font-semibold"><span class="mini-loader"></span></p>
                                      </div>
                                  </div>
                                  <div id="holdings-${id}" class="space-y-2 mb-4"></div>
                                  <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                                      <button class="health-check-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm" data-portfolio='${JSON.stringify(Object.keys(portfolio.holdings).map(ticker => ({ ticker, allocation: portfolio.holdings[ticker].allocation })))}'>Health Check</button>
                                      <button class="delete-portfolio-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full text-sm" data-id="${id}">Hapus</button>
                                  </div>`;
                portfoliosContainer.appendChild(card);
                updatePortfolioPerformance(id, portfolio);
            }

            async function updatePortfolioPerformance(id, portfolio) {
                const holdingsContainer = document.getElementById(`holdings-${id}`);
                const totalInitialValueEl = document.getElementById(`total-initial-value-${id}`);
                holdingsContainer.innerHTML = ''; 
                
                const isCrypto = portfolio.isCrypto || false;
                const sharesLabel = isCrypto ? 'Unit' : 'Lembar';
                const formatOptions = { minimumFractionDigits: isCrypto ? 4 : 0 };
                
                let totalInitialInvestment = portfolio.calculatedInitialInvestment || 0; 
                let totalCurrentInvestmentValue = 0;
                
                for (const ticker in portfolio.holdings) {
                    const holding = portfolio.holdings[ticker];
                    // IMPORTANT: TriggerBackendFetch harus menggunakan currentMarketMode yang sesuai
                    // Karena data holding sudah ada isCrypto, kita bisa membuat fungsi helper untuk API
                    const backendData = await triggerBackendFetch(ticker); 
                    const currentPrice = backendData ? backendData.regularMarketPrice : holding.initialPrice;
                    
                    const sharesBought = holding.sharesBought || 0;
                    const initialInvestment = holding.initialInvestment || 0; 
                    
                    const currentValue = sharesBought * currentPrice;

                    totalCurrentInvestmentValue += currentValue;
                    
                    const pnl = currentValue - initialInvestment;
                    const pnlPercent = initialInvestment > 0 ? (pnl / initialInvestment) * 100 : 0;
                    const pnlColor = pnl >= 0 ? 'text-green-500' : 'text-red-500';
                    const pnlIcon = pnl >= 0 ? 'caret-up' : 'caret-down';

                    const holdingDiv = document.createElement('div');
                    holdingDiv.className = 'p-3 bg-gray-50 dark:bg-gray-800 rounded-lg flex justify-between items-center text-sm';
                    holdingDiv.innerHTML = `<div>
                                                <p class="font-bold">${ticker} <span class="font-normal text-gray-500">(${holding.allocation}%)</span></p>
                                                <p class="text-xs">${new Intl.NumberFormat('id-ID', formatOptions).format(sharesBought)} ${sharesLabel} (@ ${new Intl.NumberFormat('id-ID', formatOptions).format(holding.initialPrice)})</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-semibold">${new Intl.NumberFormat('id-ID', formatOptions).format(currentPrice)}</p>
                                                <p class="${pnlColor} flex items-center justify-end gap-1"><ion-icon name="${pnlIcon}"></ion-icon> ${pnlPercent.toFixed(2)}%</p>
                                            </div>`;
                    holdingsContainer.appendChild(holdingDiv);
                }

                const totalPnl = totalCurrentInvestmentValue - totalInitialInvestment;
                const totalPnlPercent = totalInitialInvestment > 0 ? (totalPnl / totalInitialInvestment) * 100 : 0;
                const totalPnlColor = totalPnl >= 0 ? 'text-green-500' : 'text-red-500';
                const totalPnlIcon = totalPnl >= 0 ? 'caret-up' : 'caret-down';
                
                totalInitialValueEl.innerHTML = `Modal Awal Riil: <span class="font-bold">${new Intl.NumberFormat('id-ID', { minimumFractionDigits: isCrypto ? 2 : 0 }).format(totalInitialInvestment)}</span>`;

                document.getElementById(`total-value-${id}`).textContent = `${isCrypto ? '$' : 'Rp'} ${new Intl.NumberFormat('id-ID', { minimumFractionDigits: isCrypto ? 2 : 0 }).format(totalCurrentInvestmentValue)}`;
                document.getElementById(`total-pl-${id}`).innerHTML = `<span class="${totalPnlColor} flex items-center justify-end gap-1"><ion-icon name="${totalPnlIcon}"></ion-icon> ${new Intl.NumberFormat('id-ID', { minimumFractionDigits: isCrypto ? 2 : 0 }).format(totalPnl)} (${totalPnlPercent.toFixed(2)}%)</span>`;
            }
            // END MODIFIED

            async function deletePortfolio(id) {
                const isCrypto = currentMarketMode === 'crypto';
                const portfolioRef = ref(database, `users/${userId}/${isCrypto ? 'crypto_portfolios' : 'portfolios'}/${id}`);
                try {
                    await remove(portfolioRef);
                    document.getElementById(`portfolio-${id}`).remove();
                    showModal("Sukses", "Portofolio berhasil dihapus.");
                    if (portfoliosContainer.children.length === 0) {
                        loadAndDisplayPortfolios(); // Reload to show empty message
                    }
                } catch (error) {
                    console.error("Gagal menghapus portofolio:", error);
                    showModal("Error", "Gagal menghapus portofolio.");
                }
            }

            // MODIFIED: Sesuaikan Health Check untuk Kripto
            async function handlePortfolioHealthCheck(portfolioData) {
                healthCheckResultsContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                const portfolioString = portfolioData.map(p => `${p.ticker} (${p.allocation}%)`).join(', ');
                
                const isCrypto = currentMarketMode === 'crypto';
                const assetLabel = isCrypto ? 'aset kripto' : 'saham';
                const analysisContext = isCrypto ? 'dinamika pasar kripto, sentimen adopsi, dan tokenomics' : 'fundamental, valuasi, dan makroekonomi';

                const prompt = `Sebagai penasihat keuangan, lakukan analisis "health check" pada portofolio ${assetLabel} berikut: ${portfolioString}. Berdasarkan ${analysisContext} terkini, berikan:
                1.  **skor_kesehatan**: Angka 1-100.
                2.  **analisis_risiko**: Satu paragraf singkat tentang risiko utama portofolio ini.
                3.  **saran_perbaikan**: Array berisi 2-3 saran konkret untuk perbaikan.
                4.  **saham_terbaik**: Ticker ${assetLabel} dengan kinerja/prospek terbaik.
                5.  **saham_terlemah**: Ticker ${assetLabel} yang paling berisiko.
                Format jawaban sebagai JSON.`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        skor_kesehatan: { type: "NUMBER" },
                        analisis_risiko: { type: "STRING" },
                        saran_perbaikan: { type: "ARRAY", items: { type: "STRING" } },
                        saham_terbaik: { type: "STRING" },
                        saham_terlemah: { type: "STRING" }
                    },
                    required: ["skor_kesehatan", "analisis_risiko", "saran_perbaikan", "saham_terbaik", "saham_terlemah"]
                };

                const data = await fetchFromGemini(prompt, schema);
                displayHealthCheckResults(data);
            }
            // END MODIFIED

            function displayHealthCheckResults(data) {
                if (!data) {
                    healthCheckResultsContainer.innerHTML = `<p class="text-center">Gagal menganalisis portofolio.</p>`;
                    return;
                }
                
                const isCrypto = currentMarketMode === 'crypto';
                const assetLabel = isCrypto ? 'Aset Kripto' : 'Saham';

                let scoreColor;
                if (data.skor_kesehatan >= 75) scoreColor = 'text-green-500';
                else if (data.skor_kesehatan >= 50) scoreColor = 'text-yellow-500';
                else scoreColor = 'text-red-500';

                const suggestionsHTML = data.saran_perbaikan.map(saran => `<li class="flex items-start gap-2"><ion-icon name="medkit-outline" class="text-blue-500 text-xl flex-shrink-0"></ion-icon><span>${saran}</span></li>`).join('');

                healthCheckResultsContainer.innerHTML = `
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4">Hasil Health Check</h3>
                        <div class="text-center mb-6">
                            <p class="text-lg">Skor Kesehatan Portofolio</p>
                            <p class="text-7xl font-extrabold ${scoreColor}">${data.skor_kesehatan}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">/ 100</p>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <h4 class="font-bold mb-2 flex items-center gap-2"><ion-icon name="alert-circle-outline"></ion-icon> Analisis Risiko</h4>
                                <p class="text-sm p-4 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 rounded-r-lg">${data.analisis_risiko}</p>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2 flex items-center gap-2"><ion-icon name="build-outline"></ion-icon> Saran Perbaikan</h4>
                                <ul class="space-y-2 text-sm">${suggestionsHTML}</ul>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <h5 class="font-bold text-green-700 dark:text-green-300 flex items-center gap-2"><ion-icon name="trophy-outline"></ion-icon> ${assetLabel} Terbaik</h5>
                                    <p class="text-2xl font-bold">${data.saham_terbaik}</p>
                                    <button class="goto-analysis-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-4 rounded-full text-xs mt-2" data-ticker="${data.saham_terbaik}">Analisis</button>
                                </div>
                                <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                    <h5 class="font-bold text-red-700 dark:text-red-300 flex items-center gap-2"><ion-icon name="warning-outline"></ion-icon> Perlu Diwaspadai</h5>
                                    <p class="text-2xl font-bold">${data.saham_terlemah}</p>
                                    <button class="goto-analysis-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-4 rounded-full text-xs mt-2" data-ticker="${data.saham_terlemah}">Analisis</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // MODIFIED: Sesuaikan Debate Generation untuk Kripto
            async function handleDebateGeneration() {
                if (!currentAnalysisTicker) {
                    showModal("Pilih Aset", "Silakan pilih aset (saham atau kripto) dari tab lain untuk memulai debat.");
                    return;
                }
                startDebateBtn.disabled = true;
                debateResultsContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                
                const isCrypto = currentMarketMode === 'crypto';
                const assetLabel = isCrypto ? 'aset kripto' : 'saham';
                const analysisContext = isCrypto ? 'teknikal dan sentimen pasar kripto' : 'fundamental dan prospek makro';

                const prompt = `Bertindak sebagai dua analis keuangan ahli dengan pandangan berlawanan untuk ${assetLabel} ${currentAnalysisTicker}.
                - **Analis Bull**: Berikan 3 poin utama mengapa aset ini layak dibeli, didukung oleh ${analysisContext} positif.
                - **Analis Bear**: Berikan 3 poin utama mengapa investor harus berhati-hati atau menjual aset ini, didukung oleh ${analysisContext} negatif.
                Format jawaban sebagai JSON dengan kunci "bull_arguments" (array string) dan "bear_arguments" (array string).`;

                const schema = {
                    type: "OBJECT",
                    properties: {
                        bull_arguments: { type: "ARRAY", items: { type: "STRING" } },
                        bear_arguments: { type: "ARRAY", items: { type: "STRING" } }
                    },
                    required: ["bull_arguments", "bear_arguments"]
                };

                const data = await fetchFromGemini(prompt, schema);
                displayDebateResults(data);
                startDebateBtn.disabled = false;
            }
            // END MODIFIED

            function displayDebateResults(data) {
                if (!data || !data.bull_arguments || !data.bear_arguments) {
                    debateResultsContainer.innerHTML = `<p class="text-center">Gagal memuat data debat.</p>`;
                    return;
                }
                
                const bullHTML = data.bull_arguments.map(arg => `<li class="flex items-start gap-2"><ion-icon name="trending-up-outline" class="text-green-500 text-2xl flex-shrink-0"></ion-icon><span>${arg}</span></li>`).join('');
                const bearHTML = data.bear_arguments.map(arg => `<li class="flex items-start gap-2"><ion-icon name="trending-down-outline" class="text-red-500 text-2xl flex-shrink-0"></ion-icon><span>${arg}</span></li>`).join('');

                debateResultsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-left text-sm">
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <h4 class="font-bold text-lg text-green-700 dark:text-green-300 mb-3">Argumen Bull (Optimis)</h4>
                            <ul class="space-y-3">${bullHTML}</ul>
                        </div>
                        <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                            <h4 class="font-bold text-lg text-red-700 dark:text-red-300 mb-3">Argumen Bear (Pesimis)</h4>
                            <ul class="space-y-3">${bearHTML}</ul>
                        </div>
                    </div>
                `;
            }

            function renderIpoCards() {
            // MODIFIED: Hanya tampilkan jika mode saham
            if (currentMarketMode === 'crypto') {
                ipoAnalysisContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Analisis IPO hanya tersedia dalam Mode Saham.</p>`;
                loadMoreIpoBtn.style.display = 'none';
                return;
            }
            
            const toDisplay = fetchedIpoList.slice(0, displayedIpoCount + ipoBatchSize);
            ipoAnalysisContainer.innerHTML = ''; 
            
            if (toDisplay.length === 0 && fetchedIpoList.length === 0) {
                ipoAnalysisContainer.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Belum ada data IPO yang tersedia dari admin.</p>`;
                loadMoreIpoBtn.style.display = 'none';
                return;
            }

            toDisplay.forEach(ipo => {
                const status = ipo.offeringPeriod;
                const statusColor = status.toLowerCase().includes('sudah listing') ? 'bg-gray-400' : (status.toLowerCase().includes('penawaran') ? 'bg-green-500' : 'bg-blue-500');
                const card = `
                    <div class="card p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-bold">${ipo.ticker}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${ipo.companyName}</p>
                            </div>
                            <span class="text-xs font-semibold text-white ${statusColor} px-2.5 py-1 rounded-full">${status}</span>
                        </div>
                        <div class="mt-4 text-center">
                            <button class="ipo-analysis-btn bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 font-semibold py-2 px-4 rounded-full text-sm w-full hover:bg-blue-200 dark:hover:bg-blue-800" data-company="${ipo.companyName}">Dapatkan Analisis AI</button>
                        </div>
                    </div>`;
                ipoAnalysisContainer.insertAdjacentHTML('beforeend', card);
            });
            displayedIpoCount = toDisplay.length;
            loadMoreIpoBtn.style.display = displayedIpoCount >= fetchedIpoList.length ? 'none' : 'inline-block';
        }
        // AKHIR MODIFIKASI

        async function loadIpoData() {
            const ipoListRef = ref(database, 'ipo_list');
            ipoAnalysisContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
            try {
                const snapshot = await get(ipoListRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    fetchedIpoList = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key]
                    }));
                    fetchedIpoList.reverse();
                } else {
                    fetchedIpoList = [];
                }
            } catch (error) {
                console.error("Gagal memuat data IPO:", error);
                fetchedIpoList = [];
                ipoAnalysisContainer.innerHTML = `<p class="text-center text-red-500">Gagal memuat data IPO.</p>`;
            }
            displayedIpoCount = 0;
            renderIpoCards();
        }

        function populateSectors() {
                const sectors = [
                    "Energi", "Barang Baku", "Perindustrian", "Barang Konsumen Primer",
                    "Barang Konsumen Non-Primer", "Kesehatan", "Keuangan", "Properti & Real Estat",
                    "Teknologi", "Infrastruktur", "Transportasi & Logistik", "Produk Investasi Tercatat"
                ];
                const sectorSelects = [document.getElementById('sector-select'), document.getElementById('discount-sector-select')];
                sectorSelects.forEach(select => {
                    if (select) {
                        while (select.options.length > 1) { select.remove(1); }
                        sectors.forEach(sector => {
                            const option = document.createElement('option');
                            option.value = sector;
                            option.textContent = sector;
                            select.appendChild(option);
                        });
                    }
                });
            }

            loadMoreIpoBtn.addEventListener('click', renderIpoCards);
        
        // --- WATCHLIST FUNCTIONS ---
            // MODIFIED: Watchlist sekarang menyimpan data yang spesifik per mode
            async function loadWatchlist() {
                const watchlistRef = ref(database, `users/${userId}/watchlist`);
                try {
                    const snapshot = await get(watchlistRef);
                    if (snapshot.exists()) {
                        const allWatchlist = snapshot.val();
                        // Filter watchlist berdasarkan mode saat ini
                        const isCrypto = currentMarketMode === 'crypto';
                        watchlist = Object.keys(allWatchlist)
                            .filter(ticker => allWatchlist[ticker].isCrypto === isCrypto)
                            .map(ticker => ticker); // Ambil hanya array of ticker
                    } else {
                        watchlist = [];
                    }
                } catch (error) {
                    console.error("Gagal memuat watchlist:", error);
                    watchlist = [];
                }
                updateWatchlistIcons();
            }

            async function saveWatchlist(ticker, isCrypto, companyName) {
                const watchlistRef = ref(database, `users/${userId}/watchlist/${ticker}`);
                try {
                    if (watchlist.includes(ticker)) {
                        // Jika sudah ada, hapus
                        await remove(watchlistRef);
                        watchlist = watchlist.filter(t => t !== ticker);
                    } else {
                        // Jika belum ada, tambahkan
                        await set(watchlistRef, { 
                            isCrypto: isCrypto, 
                            companyName: companyName,
                            addedAt: new Date().toISOString()
                        });
                        watchlist.push(ticker);
                    }
                } catch (error) {
                    console.error("Gagal menyimpan watchlist:", error);
                }
            }

            function toggleWatchlist(ticker) {
                const isCrypto = currentMarketMode === 'crypto';
                
                // Cari nama perusahaan/koin untuk disimpan
                let companyName = ticker;
                const priceInput = document.getElementById(`price-input-${ticker}`);
                if (priceInput && priceInput.closest('.card')) {
                    const card = priceInput.closest('.card');
                    const companyNameEl = card.querySelector('.text-md');
                    if (companyNameEl) {
                        companyName = companyNameEl.textContent;
                    }
                }
                
                saveWatchlist(ticker, isCrypto, companyName);
                updateWatchlistIcons();
                if (document.getElementById('track-tab-content').offsetParent !== null) {
                    renderWatchlistPage();
                }
            }
            
            function updateWatchlistIcons() {
                // Saat ini, ikon hanya dapat berubah di mode yang sama saat item dimuat
                document.querySelectorAll('.add-to-watchlist-btn').forEach(btn => {
                    const ticker = btn.dataset.ticker;
                    const icon = btn.querySelector('ion-icon');
                    if (watchlist.includes(ticker)) {
                        icon.setAttribute('name', 'bookmark');
                        icon.classList.add('text-yellow-500');
                    } else {
                        icon.setAttribute('name', 'bookmark-outline');
                        icon.classList.remove('text-yellow-500');
                    }
                });
            }

            async function renderWatchlistPage() {
                const container = document.getElementById('watchlist-results-container');
                document.getElementById('watchlist-summary-container').innerHTML = ''; // Clear summary
                
                // Re-load watchlist untuk memastikan data terbaru sesuai mode
                await loadWatchlist(); 
                
                container.innerHTML = '';
                if (watchlist.length === 0) {
                    const isCrypto = currentMarketMode === 'crypto';
                    container.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-16">
                        <ion-icon name="bookmark-outline" class="text-6xl mx-auto"></ion-icon>
                        <p class="text-lg mt-4">Watchlist ${isCrypto ? 'Kripto' : 'Saham'} Anda kosong.</p>
                        <p class="text-sm">Tambahkan aset dengan menekan ikon <ion-icon name="bookmark-outline"></ion-icon> pada kartu aset.</p>
                    </div>`;
                    return;
                }

                container.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                const stockDataPromises = watchlist.map(ticker => triggerBackendFetch(ticker));
                const stocksData = await Promise.all(stockDataPromises);
                
                const isCrypto = currentMarketMode === 'crypto';
                const currency = isCrypto ? '$' : 'Rp';
                const formatOptions = { minimumFractionDigits: isCrypto ? 4 : 0 };
                
                container.innerHTML = '';
                stocksData.forEach((stock, index) => {
                    if (stock) {
                        const ticker = watchlist[index];
                        const item = document.createElement('div');
                        item.className = 'card p-4';
                        item.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex-grow">
                                    <h4 class="text-lg font-bold">${stock.companyName} (${ticker})</h4>
                                    <p class="text-xl font-semibold text-blue-600 dark:text-blue-400">${currency} ${new Intl.NumberFormat('id-ID', formatOptions).format(stock.regularMarketPrice)}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="goto-analysis-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-4 rounded-full text-xs" data-ticker="${ticker}">Analisis</button>
                                    <button class="add-to-watchlist-btn text-yellow-500" data-ticker="${ticker}" title="Hapus dari Watchlist">
                                        <ion-icon name="bookmark" class="text-2xl"></ion-icon>
                                    </button>
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    }
                });
            }
            
            async function handleWatchlistSummary() {
                const container = document.getElementById('watchlist-summary-container');
                container.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                
                if (watchlist.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                const isCrypto = currentMarketMode === 'crypto';
                const assetLabel = isCrypto ? 'aset kripto' : 'saham';
                const analysisContext = isCrypto ? 'pasar kripto' : 'pasar BEI';
                
                const prompt = `Berdasarkan berita ${analysisContext} dan data ekonomi terkini untuk hari ini, berikan ringkasan harian singkat (maksimal 2 kalimat per ${assetLabel}) untuk ${assetLabel} berikut di watchlist saya: ${watchlist.join(', ')}. Fokus pada berita signifikan, sinyal teknikal penting, atau rumor yang dapat memengaruhi harga. Format sebagai JSON: { "ringkasan_umum": "...", "detail_saham": [{"ticker": "...", "ringkasan": "..."}] }`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        ringkasan_umum: { type: "STRING" },
                        detail_saham: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    ticker: { type: "STRING" },
                                    ringkasan: { type: "STRING" }
                                },
                                required: ["ticker", "ringkasan"]
                            }
                        }
                    },
                    required: ["ringkasan_umum", "detail_saham"]
                };

                const data = await fetchFromGemini(prompt, schema);

                if (!data) {
                    container.innerHTML = `<p class="text-center text-red-500">Gagal memuat ringkasan AI.</p>`;
                    return;
                }

                const detailsHTML = data.detail_saham.map(item => `
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <h5 class="font-bold">${item.ticker}</h5>
                        <p class="text-sm">${item.ringkasan}</p>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="card p-6 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
                        <h3 class="text-xl font-bold text-center mb-4">Ringkasan Watchlist Harian</h3>
                        <p class="text-center text-sm mb-4">${data.ringkasan_umum}</p>
                        <div class="space-y-3">${detailsHTML}</div>
                    </div>
                `;
            }

            // --- END WATCHLIST FUNCTIONS ---
            
            // MODIFIED: Fungsi untuk membandingkan saham, menggunakan mode saat ini
            async function handleCompareStocks() {
                const inputs = document.querySelectorAll('.compare-input');
                const tickers = Array.from(inputs).map(input => input.value.trim().toUpperCase()).filter(Boolean);
                const resultsContainer = document.getElementById('compare-results-container');
                
                const isCrypto = currentMarketMode === 'crypto';

                if (tickers.length < 2) {
                    showModal("Input Kurang", `Mohon masukkan setidaknya 2 ticker ${isCrypto ? 'kripto' : 'saham'} untuk dibandingkan.`);
                    return;
                }

                resultsContainer.innerHTML = `<div class="flex justify-center p-8"><div class="loader"></div></div>`;
                
                // Panggil fungsi fundamental/metrik yang sesuai
                const dataPromises = tickers.map(async (ticker) => {
                    const fundamentalData = isCrypto ? await fetchCryptoMetrics(ticker) : await fetchFundamentalData(ticker); 
                    return { ticker, fundamentalData };
                });

                const allData = await Promise.all(dataPromises);
                
                const allLabels = new Set();
                allData.forEach(data => {
                    data.fundamentalData?.forEach(m => allLabels.add(m.label));
                });
                const sortedLabels = Array.from(allLabels).sort();
                
                let tableHTML = `
                    <div class="card p-4 overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 rounded-l-lg">${isCrypto ? 'Metrik Kripto' : 'Metrik Saham'}</th>
                                    ${tickers.map(ticker => `<th scope="col" class="px-6 py-3 text-center">${ticker}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>`;
                
                const comparisonDataForAI = {};
                tickers.forEach(ticker => comparisonDataForAI[ticker] = {});

                sortedLabels.forEach(label => {
                    tableHTML += `<tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700">
                                    <th scope="row" class="px-6 py-4 font-medium whitespace-nowrap">${label}</th>`;
                    allData.forEach(({ ticker, fundamentalData }) => {
                        const metricData = fundamentalData ? fundamentalData.find(m => m.label === label) : null;
                        const value = metricData ? metricData.nilai : 'N/A';
                        tableHTML += `<td class="px-6 py-4 text-center">${value}</td>`;
                        
                        if(metricData?.key) {
                            comparisonDataForAI[ticker][metricData.key] = value;
                        } else {
                            comparisonDataForAI[ticker][label] = value;
                        }
                    });
                    tableHTML += `</tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                
                // Prompt AI menggunakan data yang sudah distrukturkan (comparisonDataForAI)
                const prompt = `Sebagai analis keuangan, berikan kesimpulan perbandingan singkat antara ${isCrypto ? 'aset kripto' : 'saham'} berikut berdasarkan data fundamental/metrik ini: ${JSON.stringify(comparisonDataForAI)}. Fokus pada ${isCrypto ? 'aset' : 'saham'} mana yang lebih unggul untuk investor tipe value dan mana yang lebih cocok untuk investor tipe growth. Berikan jawaban dalam format JSON: { "kesimpulan": "...", "untuk_value": "...", "untuk_growth": "..." }`;
                const schema = {
                    type: "OBJECT",
                    properties: {
                        kesimpulan: { type: "STRING" },
                        untuk_value: { type: "STRING" },
                        untuk_growth: { type: "STRING" }
                    },
                    required: ["kesimpulan", "untuk_value", "untuk_growth"]
                };

                const aiSummary = await fetchFromGemini(prompt, schema);
                
                if(aiSummary) {
                    tableHTML += `
                        <div class="card p-6 mt-6 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800">
                            <h3 class="text-xl font-bold text-center mb-4">Kesimpulan AI</h3>
                            <p class="text-center mb-4">${aiSummary.kesimpulan}</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                    <h5 class="font-bold text-green-700 dark:text-green-300 flex items-center gap-2"><ion-icon name="diamond-outline"></ion-icon> Untuk Investor Value</h5>
                                    <p class="mt-1">${aiSummary.untuk_value}</p>
                                </div>
                                <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <h5 class="font-bold text-blue-700 dark:text-blue-300 flex items-center gap-2"><ion-icon name="rocket-outline"></ion-icon> Untuk Investor Growth</h5>
                                    <p class="mt-1">${aiSummary.untuk_growth}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                resultsContainer.innerHTML = tableHTML;
            }
            // END MODIFIED

            // --- SUB-TAB SWITCHING LOGIC ---
            function setupSubTabSwitching(containerSelector, buttonSelector, contentIds) {
                const container = document.querySelector(containerSelector);
                if (!container) return;

                const subTabButtons = container.querySelectorAll(buttonSelector);
                subTabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetId = button.dataset.target;
                        
                        contentIds.forEach(id => {
                            const contentElement = document.getElementById(id);
                            if(contentElement) contentElement.classList.add('hidden');
                        });
                        
                        subTabButtons.forEach(btn => btn.classList.remove('active'));
                        
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.classList.remove('hidden');
                        }
                        button.classList.add('active');
                    });
                });
                if(subTabButtons.length > 0) subTabButtons[0].click();
            }
            
            setupSubTabSwitching('#discovery-tab-content', '.sub-tab-btn', ['screener-sub-content', 'discount-hunter-sub-content', 'investor-style-sub-content', 'ipo-analysis-sub-content']);
            setupSubTabSwitching('#strategy-lab-tab-content', '.sub-tab-btn', ['ai-recommendation-sub-content', 'manual-portfolio-sub-content']);
            setupSubTabSwitching('#track-tab-content', '.sub-tab-btn', ['portfolio-sub-content', 'watchlist-sub-content']);
            setupSubTabSwitching('#analysis-tab-content', '.sub-tab-btn', ['direct-analysis-sub-content', 'compare-stocks-sub-content']);

            // Initialize the app
        loadWatchlist();
        switchTab('discovery');
        populateSectors();
        loadIpoData(); 
        }
    </script>

</body>
</html>
